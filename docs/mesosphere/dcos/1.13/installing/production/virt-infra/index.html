<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width" initial-scale="1" user-scalable="no"><title>Virtual Infrastructure - D2iQ Docs</title><meta name="description" content="Operating DC/OS on Virtualized Infrastructure - Best Practices"><link rel="apple-touch-icon" sizes="180x180" href="/dcosdocs/assets/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/dcosdocs/assets/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/dcosdocs/assets/favicon-16x16.png"><link rel="stylesheet" type="text/css" href="/dcosdocs/css/styles.css"><link rel="search" type="application/opensearchdescription+xml" href="/dcosdocs/assets/opensearch.xml" title="Search"><link href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,500,500i,700,700i" rel="stylesheet"><script src="https://unpkg.com/feather-icons/dist/feather.min.js"></script><script>window.analytics||(window.analytics=[]),window.analytics.methods=["identify","track","trackLink","trackForm","trackClick","trackSubmit","page","pageview","ab","alias","ready","group","on","once","off"],window.analytics.factory=function(t){return function(){var a=Array.prototype.slice.call(arguments);return a.unshift(t),window.analytics.push(a),window.analytics}};for(var i=0;i<window.analytics.methods.length;i++){var method=window.analytics.methods[i];window.analytics[method]=window.analytics.factory(method)}window.analytics.load=function(t){var a=document.createElement("script");a.type="text/javascript",a.async=!0,a.src=("https:"===document.location.protocol?"https://":"http://")+"d2dq2ahtl5zl1z.cloudfront.net/analytics.js/v1/"+t+"/analytics.min.js";var n=document.getElementsByTagName("script")[0];n.parentNode.insertBefore(a,n)},window.analytics.SNIPPET_VERSION="2.0.8",
window.analytics.load("7sgtwqvuai");
window.analytics.page();</script><noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-PBJ84KX" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript><script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src='//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-PBJ84KX');</script></head><body><div class="layout"><header class="header"><a class="header__drawer"><i class="header__icon" data-feather="menu"></i></a><a class="header__logo" href="/"><img class="header__logo--mobile" src="/dcosdocs/assets/D2iQ_Logotype_Color_Positive_Documentation.svg" alt="D2IQ"><img class="header__logo--desktop" src="/dcosdocs/assets/D2iQ_Logotype_Color_Positive_Documentation.svg" alt="D2IQ"></a><div class="header__main"><div class="header__dropdown"><img class="header__dropdown-icon" src="/dcosdocs/assets/D2IQ_Logotype_Color_Positive.png" alt="D2iQ"><strong>DC/OS Documentation</strong><i data-feather="chevron-down"></i></div><nav class="header__menu"><ul class="header__menu-list"><li class="header__menu-item"><a href="/mesosphere/dcos">DC/OS</a></li><li class="header__menu-item"><a href="/dcosdocs/mesosphere/dcos/services">Services</a></li><li class="header__menu-item"><a href="https://support.d2iq.com">Support</a></li></ul></nav></div><div class="chooser" id="localizer"><div class="chooser-current"><a class="chooser-title">English</a><svg class="chooser-svg" id="localizer-svg"><path class="pointer" d="m 13,6 -5,5 -5,-5 z" fill="#858585"></path></svg></div><ul class="chooser-list" id="localizer-list"><li class="chooser-list-item"><a href="/dcosdocs/mesosphere/dcos/cn/1.13/installing/production/virt-infra">中文 (简体)</a></li></ul></div><section class="header__search" role="search"><form class="header__search-form" action="/search/"><input class="header__search-input" id="header-search-input" tabindex="1" type="text" name="q" placeholder="Search"><input type="hidden" name="hFR[scope][0]" value="DC/OS 1.13"><label class="header__search-label" for="header-search-input"><i class="header__icon" data-feather="search"></i></label></form></section></header><div class="header-dropdown"><ul class="header-dropdown__list"><li class="header-dropdown__top-item"><div>DKP</div></li><li class="header-dropdown__item"><a href="/dkp/konvoy">Konvoy</a></li><li class="header-dropdown__item"><a href="/dkp/kommander">Kommander</a></li><li class="header-dropdown__item"><a href="/dkp/dispatch">Dispatch</a></li><li class="header-dropdown__item"><a href="/dkp/kaptain">Kaptain</a></li><li class="header-dropdown__top-item"><div>Mesosphere</div></li><li class="header-dropdown__item header-dropdown__item--active"><a href="/mesosphere/dcos">DC/OS</a></li><li class="header-dropdown__item"><a href="/dcosdocs/mesosphere/dcos/services">DC/OS Services</a></li><li class="header-dropdown__item"><a href="https://support.d2iq.com">Support</a></li></ul></div><div class="layout__sidebar layout__drawer"><section class="sidebar"><header class="sidebar__header"><div class="sidebar__dropdown"><ul><li><a href="/dcosdocs/mesosphere/dcos/2.2/installing/production/virt-infra">Mesosphere DC/OS 2.2.0</a></li><li><a href="/dcosdocs/mesosphere/dcos/2.1/installing/production/virt-infra">Mesosphere DC/OS 2.1.0</a></li><li><a href="/dcosdocs/mesosphere/dcos/2.0/installing/production/virt-infra">Mesosphere DC/OS 2.0</a></li><li><a href="/dcosdocs/mesosphere/dcos/1.13/installing/production/virt-infra">Mesosphere DC/OS 1.13</a></li></ul><div class="toggle"><p><span class="title">DC/OS</span><span class="version"> 1.13</span></p><i data-feather="chevron-down"></i></div></div></header><nav class="sidebar_nav" role="navigation"><ul><li><a class="d0" href="/dcosdocs/mesosphere/dcos/1.13/release-notes/"><i data-feather="chevron-right"></i>Release Notes</a></li><li><a class="d0" href="/dcosdocs/mesosphere/dcos/1.13/overview/"><i data-feather="chevron-right"></i>Overview</a></li><li class="active"><a class="d0" href="/dcosdocs/mesosphere/dcos/1.13/installing/"><i data-feather="chevron-right"></i>Installing</a></li><ul><li><a class="d1" href="/dcosdocs/mesosphere/dcos/1.13/installing/evaluation/"><i data-feather="chevron-right"></i>Cloud Installation</a></li><li class="active"><a class="d1" href="/dcosdocs/mesosphere/dcos/1.13/installing/production/"><i data-feather="chevron-right"></i>On-Prem Installation</a></li><ul><li class="active active-on"><a class="d2" href="/dcosdocs/mesosphere/dcos/1.13/installing/production/virt-infra/">Virtual Infrastructure</a></li><li><a class="d2" href="/dcosdocs/mesosphere/dcos/1.13/installing/production/system-requirements/"><i data-feather="chevron-right"></i>System Requirements</a></li><li><a class="d2" href="/dcosdocs/mesosphere/dcos/1.13/installing/production/deploying-dcos/"><i data-feather="chevron-right"></i>Deploying DC/OS</a></li><li><a class="d2" href="/dcosdocs/mesosphere/dcos/1.13/installing/production/advanced-configuration/"><i data-feather="chevron-right"></i>Advanced Configuration</a></li><li><a class="d2" href="/dcosdocs/mesosphere/dcos/1.13/installing/production/dcos-ansible/"><i data-feather="chevron-right"></i>DC/OS with Ansible</a></li><li><a class="d2" href="/dcosdocs/mesosphere/dcos/1.13/installing/production/patching/">Patching</a></li><li><a class="d2" href="/dcosdocs/mesosphere/dcos/1.13/installing/production/upgrading/">Upgrading</a></li><li><a class="d2" href="/dcosdocs/mesosphere/dcos/1.13/installing/production/uninstalling/">Uninstalling</a></li></ul><li><a class="d1" href="/dcosdocs/mesosphere/dcos/1.13/installing/installation-faq/">Frequently Asked Questions</a></li><li><a class="d1" href="/dcosdocs/mesosphere/dcos/1.13/installing/troubleshooting/">Troubleshooting</a></li></ul><li><a class="d0" href="/dcosdocs/mesosphere/dcos/1.13/gui/"><i data-feather="chevron-right"></i>GUI</a></li><li><a class="d0" href="/dcosdocs/mesosphere/dcos/1.13/cli/"><i data-feather="chevron-right"></i>CLI</a></li><li><a class="d0" href="/dcosdocs/mesosphere/dcos/1.13/administering-clusters/"><i data-feather="chevron-right"></i>Administering Clusters</a></li><li><a class="d0" href="/dcosdocs/mesosphere/dcos/1.13/networking/"><i data-feather="chevron-right"></i>Networking</a></li><li><a class="d0" href="/dcosdocs/mesosphere/dcos/1.13/security/"><i data-feather="chevron-right"></i>Security</a></li><li><a class="d0" href="/dcosdocs/mesosphere/dcos/1.13/storage/"><i data-feather="chevron-right"></i>Storage</a></li><li><a class="d0" href="/dcosdocs/mesosphere/dcos/1.13/metrics/"><i data-feather="chevron-right"></i>Metrics</a></li><li><a class="d0" href="/dcosdocs/mesosphere/dcos/1.13/monitoring/"><i data-feather="chevron-right"></i>Monitoring, Logging, and Debugging</a></li><li><a class="d0" href="/dcosdocs/mesosphere/dcos/1.13/hybrid-cloud/"><i data-feather="chevron-right"></i>Hybrid Cloud</a></li><li><a class="d0" href="/dcosdocs/mesosphere/dcos/1.13/deploying-jobs/"><i data-feather="chevron-right"></i>Deploying Jobs</a></li><li><a class="d0" href="/dcosdocs/mesosphere/dcos/1.13/deploying-services/"><i data-feather="chevron-right"></i>Deploying Services and Pods</a></li><li><a class="d0" href="/dcosdocs/mesosphere/dcos/1.13/tutorials/"><i data-feather="chevron-right"></i>Tutorials</a></li><li><a class="d0" href="/dcosdocs/mesosphere/dcos/1.13/api/"><i data-feather="chevron-right"></i>API Reference</a></li><li><a class="d0" href="/dcosdocs/mesosphere/dcos/1.13/developing-services/"><i data-feather="chevron-right"></i>Developing DC/OS Services</a></li></ul></nav><footer class="sidebar__footer"><div class="sidebar__footer-links"><a href="https://d2iq.com/terms/">Terms of Service</a><a href="https://d2iq.com/privacy/">Privacy Policy</a></div><a class="sidebar__footer-copyright" href="https://d2iq.com/">&copy; 2022 D2iQ, Inc. All rights reserved.</a></footer></section></div><div class="layout__content" role="main"><main class="content"><div class="content__container content__container--with-sections"><div class="content__header"><div class="content__header__row"><h1 class="content__header-title">Virtual Infrastructure</h1></div><h4 class="content__header-description">Operating DC/OS on Virtualized Infrastructure - Best Practices</h4><div class="actions"><ul class="actions__list"><li class="actions__item"><button class="actions__link" onclick="javascript:window.print()"><i class="actions__icon" data-feather="printer"></i><span class="actions__text">Print</span></button></li><li class="actions__item"><a class="actions__link" href="https://github.com/mesosphere/dcos-docs-site/tree/main/pages/dcosdocs/mesosphere/dcos/1.13/installing/production/virt-infra/index.md" target="_blank"><i class="actions__icon" data-feather="github"></i><span class="actions__text">Contribute</span></a></li></ul></div></div><article class="content__article"><p>The following is intended to provide operational guidance to customers running DC/OS clusters on virtualized infrastructure. While the guidance below references VMware vSphere concepts, similar settings should be applied to other hypervisors and virtualization technologies.</p>
<p>Please contact your customer success team for additional guidance.</p>
<h1 id="performance-and-capacity-guidelines"><a class="content__anchor" href="#performance-and-capacity-guidelines" aria-hidden="true"><i data-feather="bookmark"></i></a>Performance and Capacity Guidelines</h1>
<h2 id="recommendations"><a class="content__anchor" href="#recommendations" aria-hidden="true"><i data-feather="bookmark"></i></a>Recommendations:</h2>
<ul>
<li>Minimize excess oversubscription of CPU and other resources on hosts</li>
<li>Keep CPU Ready Time* &lt;5% on hosts where DC/OS master nodes are scheduled</li>
</ul>
<p class="message--note"><strong>NOTE: </strong>CPU ready time is a metric that records the amount of time a virtual machine is ready to use CPU but was unable to schedule time because all CPU resources are busy.</p>
<h1 id="time-keeping-guidelines"><a class="content__anchor" href="#time-keeping-guidelines" aria-hidden="true"><i data-feather="bookmark"></i></a>Time Keeping Guidelines</h1>
<p>A DC/OS cluster requires robust time synchronization between nodes for optimal functionality. Please check that <a href="/dcosdocs/mesosphere/dcos/1.13/installing/production/system-requirements/#synchronize-time-for-all-nodes-in-the-cluster">NTP is enabled</a> on your DC/OS cluster to help ensure such robust synchronization.</p>
<h2 id="recommendations-2"><a class="content__anchor" href="#recommendations-2" aria-hidden="true"><i data-feather="bookmark"></i></a>Recommendations:</h2>
<ul>
<li>
<p>Disable VMware Tools time synchronization and <a href="https://blogs.vmware.com/vsphere/2018/07/timekeeping-within-esxi.html">configure ESXi hosts and guests to use a reliable NTP source</a></p>
</li>
<li>
<p>Add the following lines to the VM configuration file (.vmx) <a href="https://kb.vmware.com/s/article/1189">to disable time synchronization</a>:</p>
</li>
</ul>
<pre><code>tools.syncTime = &quot;0&quot;
time.synchronize.continue = &quot;0&quot;
time.synchronize.restore = &quot;0&quot;
time.synchronize.resume.disk = &quot;0&quot;
time.synchronize.shrink = &quot;0&quot;
time.synchronize.tools.startup = &quot;0&quot;
time.synchronize.tools.enable = &quot;0&quot;
time.synchronize.resume.host = &quot;0&quot;
</code></pre>
<h3 id="optional"><a class="content__anchor" href="#optional" aria-hidden="true"><i data-feather="bookmark"></i></a>Optional</h3>
<ul>
<li>Consider disabling slew mode for NTP using <code>ntpd -x</code>.</li>
<li>Set <code>tinker panic</code> to <code>0</code> in the NTP configuration.</li>
</ul>
<h1 id="vsphere-drs-settings"><a class="content__anchor" href="#vsphere-drs-settings" aria-hidden="true"><i data-feather="bookmark"></i></a>vSphere DRS Settings</h1>
<p>DRS (<a href="https://www.vmware.com/products/vsphere/drs-dpm.html">Distributed Resource Scheduler</a>) is a vSphere feature that balances computing workloads with available resources in a vSphere cluster.</p>
<p>It is recommended that DRS automation is set to disabled or partially automated for master and agent nodes that have Zookeeper and etcd components scheduled on them. vSphere clusters under load can cause erratic behavior on Zookeeper ensembles or etcd clusters if multiple live migration actions are initiated. A live migration (vMotion) may issue a <a href="https://cormachogan.com/2015/04/28/when-and-why-do-we-stun-a-virtual-machine/">“stop the world” pause</a> (also known as a “stun”) in order to complete the migration to another host.</p>
<p>Also note that Zookeeper and etcd might experience a failover event when live migration is triggered under certain conditions and care should be taken to not lose multiple members in an ensemble that violates the number of failures that can be tolerated. Accordingly, a Zookeeper ensemble of 3 can tolerate the failure of one server while an ensemble of 5 can tolerate the failure of two servers.</p>
<h2 id="recommendations-3"><a class="content__anchor" href="#recommendations-3" aria-hidden="true"><i data-feather="bookmark"></i></a>Recommendations:</h2>
<ul>
<li>Set DRS “Automation Level” to “Disabled” or “Partially Automated” for DC/OS master nodes and any nodes hosting Zookeeper or etcd instances.</li>
<li>Create a VM-VM anti-affinity rule to prevent DC/OS master nodes from being scheduled on the same hosts.</li>
<li>Consider creating anti-affinity rules/policies for other standalone Zookeeper or etcd nodes deployed on DC/OS to ensure a host (hypervisor) failure does not result in a service outage.</li>
<li>Consider creating anti-affinity rules/policies for agent nodes if you have capacity available in your virtualization cluster or are operating a large DC/OS cluster.</li>
<li>Factor in fault domain considerations such as racks, rows and datacenters to ensure resilient resource placement for virtual machines (and DC/OS nodes).</li>
</ul>
<h3 id="optional-2"><a class="content__anchor" href="#optional-2" aria-hidden="true"><i data-feather="bookmark"></i></a>Optional:</h3>
<ul>
<li>Set “vSphere Latency Sensitivity” to “High” for DC/OS master nodes</li>
</ul>
<h1 id="vsphere-ha-settings"><a class="content__anchor" href="#vsphere-ha-settings" aria-hidden="true"><i data-feather="bookmark"></i></a>vSphere HA Settings</h1>
<p>Hosts in a vSphere HA cluster are monitored and in the event of a failure, the virtual machines on a failed host are restarted on alternate hosts in the cluster.</p>
<h2 id="recommendations-4"><a class="content__anchor" href="#recommendations-4" aria-hidden="true"><i data-feather="bookmark"></i></a>Recommendations:</h2>
<ul>
<li>Set a higher restart priority for DC/OS master nodes in comparison to DC/OS agent nodes.</li>
</ul>
</article></div><aside class="content__sections"><div class="content__sections-list-container"><ul class="content__sections-list"><li class="content__sections-item content__sections-item--h1"><a href="#performance-and-capacity-guidelines">Performance and Capacity Guidelines</a></li><li class="content__sections-item content__sections-item--h2"><a href="#recommendations">Recommendations:</a></li><li class="content__sections-item content__sections-item--h1"><a href="#time-keeping-guidelines">Time Keeping Guidelines</a></li><li class="content__sections-item content__sections-item--h2"><a href="#recommendations-2">Recommendations:</a></li><li class="content__sections-item content__sections-item--h1"><a href="#vsphere-drs-settings">vSphere DRS Settings</a></li><li class="content__sections-item content__sections-item--h2"><a href="#recommendations-3">Recommendations:</a></li><li class="content__sections-item content__sections-item--h1"><a href="#vsphere-ha-settings">vSphere HA Settings</a></li><li class="content__sections-item content__sections-item--h2"><a href="#recommendations-4">Recommendations:</a></li></ul></div></aside></main></div></div><script src="/dcosdocs/assets/js/jquery-3.2.1.js"></script><script src="/dcosdocs/assets/js/clipboard.js"></script><script src="/dcosdocs/assets/js/prism.js"></script><script src="/js/main.js"></script></body></html>