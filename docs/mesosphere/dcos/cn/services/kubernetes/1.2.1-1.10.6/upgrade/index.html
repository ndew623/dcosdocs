<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width" initial-scale="1" user-scalable="no"><title>已升级 - D2iQ Docs</title><meta name="description" content="更新和升级 Kubernetes"><link rel="apple-touch-icon" sizes="180x180" href="/assets/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/favicon-16x16.png"><link rel="stylesheet" type="text/css" href="/dcosdocs/css/styles.css"><link rel="search" type="application/opensearchdescription+xml" href="/assets/opensearch.xml" title="Search"><link href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,500,500i,700,700i" rel="stylesheet"><script src="https://unpkg.com/feather-icons/dist/feather.min.js"></script><script>window.analytics||(window.analytics=[]),window.analytics.methods=["identify","track","trackLink","trackForm","trackClick","trackSubmit","page","pageview","ab","alias","ready","group","on","once","off"],window.analytics.factory=function(t){return function(){var a=Array.prototype.slice.call(arguments);return a.unshift(t),window.analytics.push(a),window.analytics}};for(var i=0;i<window.analytics.methods.length;i++){var method=window.analytics.methods[i];window.analytics[method]=window.analytics.factory(method)}window.analytics.load=function(t){var a=document.createElement("script");a.type="text/javascript",a.async=!0,a.src=("https:"===document.location.protocol?"https://":"http://")+"d2dq2ahtl5zl1z.cloudfront.net/analytics.js/v1/"+t+"/analytics.min.js";var n=document.getElementsByTagName("script")[0];n.parentNode.insertBefore(a,n)},window.analytics.SNIPPET_VERSION="2.0.8",
window.analytics.load("7sgtwqvuai");
window.analytics.page();</script><noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-PBJ84KX" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript><script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src='//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-PBJ84KX');</script></head><body><div class="layout"><header class="header"><a class="header__drawer"><i class="header__icon" data-feather="menu"></i></a><a class="header__logo" href="/"><img class="header__logo--mobile" src="/assets/D2iQ_Logotype_Color_Positive_Documentation.svg" alt="D2IQ"><img class="header__logo--desktop" src="/assets/D2iQ_Logotype_Color_Positive_Documentation.svg" alt="D2IQ"></a><div class="header__main"><div class="header__dropdown"><img class="header__dropdown-icon" src="/assets/D2IQ_Logotype_Color_Positive.png" alt="D2iQ"><strong>Kubernetes文档</strong><i data-feather="chevron-down"></i></div><nav class="header__menu"><ul class="header__menu-list"><li class="header__menu-item"><a href="https://support.d2iq.com">Support</a></li></ul></nav></div><div class="chooser" id="spherer"><div class="chooser-current"><a class="chooser-title">Mesosphere</a><svg class="chooser-svg" id="spherer-svg"><path class="pointer" d="m 13,6 -5,5 -5,-5 z" fill="#858585"></path></svg></div><ul class="chooser-list" id="spherer-list"><li class="chooser-list-item"><a href="/mesosphere/dcos">DC/OS</a></li><li class="chooser-list-item"><a href="/dcosdocs/mesosphere/dcos/services">DC/OS Services</a></li></ul></div><div class="chooser" id="ks"><div class="chooser-current"><a class="chooser-title">DKP</a><svg class="chooser-svg" id="kspherer-svg"><path class="pointer" d="m 13,6 -5,5 -5,-5 z" fill="#858585"></path></svg></div><ul class="chooser-list" id="kspherer-list"><li class="chooser-list-item"><a href="/dkp/konvoy">Konvoy</a></li><li class="chooser-list-item"><a href="/dkp/konvoy/partner-solutions">Partner Solutions</a></li><li class="chooser-list-item"><a href="/dkp/kommander">Kommander</a></li><li class="chooser-list-item"><a href="/dkp/dispatch">Dispatch</a></li><li class="chooser-list-item"><a href="/dkp/kaptain">Kaptain</a></li><li class="chooser-list-item"><a href="/dkp/conductor">Conductor</a></li></ul></div><div class="chooser" id="localizer"><div class="chooser-current"><a class="chooser-title">中文 (简体)</a><svg class="chooser-svg" id="localizer-svg"><path class="pointer" d="m 13,6 -5,5 -5,-5 z" fill="#858585"></path></svg></div><ul class="chooser-list" id="localizer-list"><li class="chooser-list-item"><a href="/dcosdocs/mesosphere/dcos/services/kubernetes">English</a></li></ul></div><section class="header__search" role="search"><form class="header__search-form" action="/search/"><input class="header__search-input" id="header-search-input" tabindex="1" type="text" name="q" placeholder="Search"><input type="hidden" name="hFR[scope][0]" value="DC/OS Services"><label class="header__search-label" for="header-search-input"><i class="header__icon" data-feather="search"></i></label></form></section></header><div class="header-dropdown"><ul class="header-dropdown__list"><li class="header-dropdown__top-item"><div>DKP</div></li><li class="header-dropdown__item"><a href="/dkp/konvoy">Konvoy</a></li><li class="header-dropdown__item"><a href="/dkp/konvoy/partner-solutions">Partner Solutions</a></li><li class="header-dropdown__item"><a href="/dkp/kommander">Kommander</a></li><li class="header-dropdown__item"><a href="/dkp/dispatch">Dispatch</a></li><li class="header-dropdown__item"><a href="/dkp/kaptain">Kaptain</a></li><li class="header-dropdown__item"><a href="/dkp/conductor">Conductor</a></li><li class="header-dropdown__top-item"><div>Mesosphere</div></li><li class="header-dropdown__item header-dropdown__item--active"><a href="/mesosphere/dcos">DC/OS</a></li><li class="header-dropdown__item"><a href="/dcosdocs/mesosphere/dcos/services">DC/OS Services</a></li><li class="header-dropdown__item"><a href="https://support.d2iq.com">Support</a></li></ul></div><div class="layout__sidebar layout__drawer"><section class="sidebar"><header class="sidebar__header"><div class="sidebar__dropdown"><div class="toggle"><p><span class="title">Kubernetes</span><span class="version"> 1.2.1-1.10.6</span></p></div></div></header><nav class="sidebar_nav" role="navigation"><ul><li><a class="d0" href="/dcosdocs/mesosphere/dcos/cn/services/kubernetes/1.2.1-1.10.6/install/">安装和自定义</a></li><li><a class="d0" href="/dcosdocs/mesosphere/dcos/cn/services/kubernetes/1.2.1-1.10.6/advanced-install/">高级安装</a></li><li><a class="d0" href="/dcosdocs/mesosphere/dcos/cn/services/kubernetes/1.2.1-1.10.6/quick-start/">快速启动</a></li><li><a class="d0" href="/dcosdocs/mesosphere/dcos/cn/services/kubernetes/1.2.1-1.10.6/uninstall/">卸载</a></li><li><a class="d0" href="/dcosdocs/mesosphere/dcos/cn/services/kubernetes/1.2.1-1.10.6/cluster_sizing/">群集大小</a></li><li class="active active-on"><a class="d0" href="/dcosdocs/mesosphere/dcos/cn/services/kubernetes/1.2.1-1.10.6/upgrade/">已升级</a></li><li><a class="d0" href="/dcosdocs/mesosphere/dcos/cn/services/kubernetes/1.2.1-1.10.6/limitations/">限制</a></li><li><a class="d0" href="/dcosdocs/mesosphere/dcos/cn/services/kubernetes/1.2.1-1.10.6/exposing-the-kubernetes-api/">暴露 Kubernetes API</a></li><li><a class="d0" href="/dcosdocs/mesosphere/dcos/cn/services/kubernetes/1.2.1-1.10.6/exposing-the-kubernetes-api-marathonlb/">通过 Marathon-LB 或 Edge-LB 暴露 Kubernetes API</a></li><li><a class="d0" href="/dcosdocs/mesosphere/dcos/cn/services/kubernetes/1.2.1-1.10.6/connecting-clients/">连接客户端</a></li><li><a class="d0" href="/dcosdocs/mesosphere/dcos/cn/services/kubernetes/1.2.1-1.10.6/kubernetes-dashboard/">Kubernetes 仪表板</a></li><li><a class="d0" href="/dcosdocs/mesosphere/dcos/cn/services/kubernetes/1.2.1-1.10.6/authn-and-authz/">授权</a></li><li><a class="d0" href="/dcosdocs/mesosphere/dcos/cn/services/kubernetes/1.2.1-1.10.6/troubleshooting-etcd/">故障排除</a></li><li><a class="d0" href="/dcosdocs/mesosphere/dcos/cn/services/kubernetes/1.2.1-1.10.6/disaster-recovery/">灾难恢复</a></li><li><a class="d0" href="/dcosdocs/mesosphere/dcos/cn/services/kubernetes/1.2.1-1.10.6/ingress/">外部入口</a></li><li><a class="d0" href="/dcosdocs/mesosphere/dcos/cn/services/kubernetes/1.2.1-1.10.6/supported-versions/">支持的版本</a></li><li><a class="d0" href="/dcosdocs/mesosphere/dcos/cn/services/kubernetes/1.2.1-1.10.6/release-notes/">版本注释</a></li></ul></nav><footer class="sidebar__footer"><div class="sidebar__footer-links"><a href="https://d2iq.com/terms/">Terms of Service</a><a href="https://d2iq.com/privacy/">Privacy Policy</a></div><a class="sidebar__footer-copyright" href="https://d2iq.com/">&copy; 2021 D2iQ, Inc. All rights reserved.</a></footer></section></div><div class="layout__content" role="main"><main class="content"><div class="content__container content__container--with-sections"><div class="content__header"><div class="content__header__row"><h1 class="content__header-title">已升级</h1></div><h4 class="content__header-description">更新和升级 Kubernetes</h4><div class="actions"><ul class="actions__list"><li class="actions__item"><button class="actions__link" onclick="javascript:window.print()"><i class="actions__icon" data-feather="printer"></i><span class="actions__text">Print</span></button></li><li class="actions__item"><a class="actions__link" href="https://github.com/mesosphere/dcos-docs-site/tree/master/pages/dcosdocs/mesosphere/dcos/cn/services/kubernetes/1.2.1-1.10.6/upgrade/index.md" target="_blank"><i class="actions__icon" data-feather="github"></i><span class="actions__text">Contribute</span></a></li><li class="actions__item"><a class="actions__link" href="https://dcos-community.slack.com/" target="_blank"><i class="actions__icon" data-feather="slack"></i><span class="actions__text">Discuss</span></a></li><li class="actions__item"><a class="actions__link" href="https://jira.d2iq.com/secure/CreateIssueDetails!init.jspa?pid=14105&amp;issuetype=1&amp;summary=Feedback+for+已升级&amp;description=Source:%20https://docs.d2iq.com/dcosdocs/mesosphere/dcos/cn/services/kubernetes/1.2.1-1.10.6/upgrade&amp;labels=documentation&amp;labels=needs_triage&amp;components=19804&amp;priority=3&amp;customfield_12300=44" target="_blank"><i class="actions__icon" data-feather="message-square"></i><span class="actions__text">Feedback</span></a></li></ul></div></div><article class="content__article"><h2 id=""><a class="content__anchor" href="#" aria-hidden="true"><i data-feather="bookmark"></i></a>在您开始之前</h2>
<p>当前，更新包可能会触发子集或
此框架管理的所有组件的更新，这取决于
这些新的组件或相关组件是否是新版本的一部分。</p>
<p>更新这些组件意味着 Kubernetes 集群可能会经历某些
停机，或者在最坏的情况下，停止正常运行。同时，
尽管我们致力于让用户的体验尽可能稳健和顺畅，
但事实上，并没有什么防故障软件。</p>
<p>在更新包版本之前，<strong>请谨慎操作并始终备份您的数据</strong>。</p>
<p>未来，我们将整合灾难恢复功能，
这样，您就可以轻松恢复到前一个功能状态。</p>
<h3 id="vs"><a class="content__anchor" href="#vs" aria-hidden="true"><i data-feather="bookmark"></i></a>更新包 vs 更新包选项</h3>
<p>当新包可用时，您可以选择更新至
新版本。如果您一段时间内未更新包，可能是
不允许更新到最新的包版本。如果是这种
情况，您将获得如何继续的信息。请注意，DC/OS 开源
版本需要额外的 <a href="#dcos-open-edition">步骤</a> 来更新包版本。</p>
<p>然而，您可能只需要更新包选项，例如，
为了更改分配给一种 Kubernetes 组件的资源。
请记住，包选项更新也可能意味着 Kubernetes
集群会经历某些停机，或者在最坏的情况下，停止
正常运行。</p>
<p>在更新包选项之前，<strong>请谨慎操作并始终备份您的数据</strong>。</p>
<h2 id="-2"><a class="content__anchor" href="#-2" aria-hidden="true"><i data-feather="bookmark"></i></a>更新</h2>
<p>要更新包，可以使用 <code>dcos kubernetes update</code>
子命令。</p>
<pre><code class="language-shell">$ dcos kubernetes update -h
usage: dcos kubernetes [&lt;flags&gt;] update [&lt;flags&gt;]

Flags:
  -h, --help               Show context-sensitive help.
  -v, --verbose            Enable extra logging of requests/responses
      --name=&quot;kubernetes&quot;  Name of the service instance to query
      --options=OPTIONS    Path to a JSON file containing the target package options
      --package-version=PACKAGE-VERSION
                           The target package version
      --yes                Do not ask for confirmation before starting the update process
      --timeout=1200s      Maximum time to wait for the update process to complete
</code></pre>
<p><strong>重要信息：</strong> 如果您拥有多个 Kubernetes 节点的集群，我们
建议将 <code>--timeout</code> 值调整为更大的值。但是，我们不能
提前计算该值应为多少，因为考虑到涉及的变量，
例如，可用的 DC/OS 集群资源、CPU 和互联网速度
等等</p>
<h3 id="-3"><a class="content__anchor" href="#-3" aria-hidden="true"><i data-feather="bookmark"></i></a>更新包版本</h3>
<p>在开始更新进程之前，必须将 CLI
更新到新版本：</p>
<pre><code class="language-shell">$ dcos package install kubernetes --cli --package-version=&lt;NEW_VERSION&gt;
</code></pre>
<h4 id="dcos"><a class="content__anchor" href="#dcos" aria-hidden="true"><i data-feather="bookmark"></i></a>DC/OS 企业版</h4>
<p>以下是您开始包版本更新的方式：</p>
<pre><code class="language-shell">$ dcos kubernetes update --package-version=&lt;NEW_VERSION&gt;
About to start an update from version &lt;CURRENT_VERSION&gt; to &lt;NEW_VERSION&gt;

Updating these components means the Kubernetes cluster may experience some
downtime or, in the worst-case scenario, cease to function properly.
Before updating proceed cautiously and always backup your data.

This operation is long-running and has to run to completion.
Are you sure you want to continue? [yes/no] yes

2018/03/01 15:40:14 starting update process...
2018/03/01 15:40:15 waiting for update to finish...
2018/03/01 15:41:56 update complete!
</code></pre>
<h4 id="dcos-2"><a class="content__anchor" href="#dcos-2" aria-hidden="true"><i data-feather="bookmark"></i></a>DC/OS 开源版本</h4>
<p>与企业版本相比，DC/OS 开源包升级需要一些额外的
步骤，以实现相同的结果。</p>
<p>首先，将当前包配置导入名为 <code>config.json</code> 的 JSON 文件：</p>
<pre><code class="language-shell">$ dcos kubernetes describe &gt; config.json
</code></pre>
<p>要以非破坏性方式进行升级，首先删除 DC/OS Kubernetes
调度器，通过运行：</p>
<pre><code class="language-shell">$ dcos marathon app remove /kubernetes
</code></pre>
<p>然后安装包的新版本：</p>
<pre><code class="language-shell">$ dcos package install kubernetes --package-version=&lt;NEW_VERSION&gt; --options=config.json
</code></pre>
<h3 id="-4"><a class="content__anchor" href="#-4" aria-hidden="true"><i data-feather="bookmark"></i></a>更新包选项</h3>
<p>此包揭示了某些选项，高级用户可根据自己的需要
使用这些选项来更新 Kubernetes 集群。例如，您可能想要
增加 <code>kube-apiserver</code> 计数或用于 <code>kube-proxy</code> 的资源。
举个例子，我们将描述如何实现后者。</p>
<p>假设您已使用默认选项安装包，那么
您所要做的只是使用以下内容
创建 JSON 文件：</p>
<pre><code class="language-json">{
  &quot;kube_proxy&quot;: {
    &quot;cpus&quot;: 0.5,
    &quot;mem&quot;: 1024
  }
}
</code></pre>
<p>假设文件被保存为 <code>new_options.json</code>，运行：</p>
<pre><code class="language-shell">$ dcos kubernetes update --options=new_options.json
</code></pre>
<p>以下为预期输出。请注意，更改以
文本 <code>(CHANGED)</code> 进行突出显示：</p>
<pre><code class="language-shell">The following differences were detected between service configurations (CHANGED, CURRENT):
 ==  {
 ==  &quot;kube_proxy&quot;: {
 -      &quot;cpus&quot;: 0.1,
 +      &quot;cpus&quot;: 0.5,
 -      &quot;mem&quot;: 512,
 +      &quot;mem&quot;: 1024,
 ==  }
 == }

The components of the cluster will be updated according to the changes in the
options file [new_options.json].

Updating these components means the Kubernetes cluster may experience some
downtime or, in the worst-case scenario, cease to function properly.
Before updating proceed cautiously and always backup your data.

This operation is long-running and has to run to completion.
Are you sure you want to continue? [yes/no] yes

2018/03/01 15:40:14 starting update process...
2018/03/01 15:40:15 waiting for update to finish...
2018/03/01 15:41:56 update complete!
</code></pre>
<h4 id="-5"><a class="content__anchor" href="#-5" aria-hidden="true"><i data-feather="bookmark"></i></a>值得注意的包选项</h4>
<p>某些包选项有着特殊意义，他们 <strong>必须</strong>只在
包安装后更新 <strong>一次</strong>，并且仅朝向特定目标
值。这些包选项是</p>
<ul>
<li><code>kubernetes.cloud_provider</code>：必须只有在
选项的初始值是 <code>&quot;&quot;</code> 以及目标值为 <code>&quot;aws&quot;</code> 时进行更新。</li>
<li><code>kubernetes.high_availability</code>：必须只有在
选项的初始值是 <code>false</code> 以及目标值为 <code>true</code> 时进行更新。</li>
</ul>
<p>此外，一些包选项 <strong>不得</strong> 在包被第一次安装后有 <strong>任何</strong>
更改。这些包选项是：</p>
<ul>
<li><code>etcd.data_disk</code></li>
<li><code>etcd.disk_type</code></li>
<li><code>etcd.wal_disk</code></li>
<li><code>kubernetes.network_provider</code></li>
<li><code>kubernetes.service_cidr</code></li>
<li><code>service.name</code></li>
<li><code>kubernetes.authorization_mode</code></li>
</ul>
<p>请确保您理解并尊重这些规则。否则，您可能会
使您的集群不可用且面临丢失数据的风险。</p>
<h2 id="120-1105"><a class="content__anchor" href="#120-1105" aria-hidden="true"><i data-feather="bookmark"></i></a>更新 <code>1.2.0-1.10.5</code> 之前版本中的包选项</h2>
<p>如果用户运行 <code>1.2.0-1.10.5</code> 之前的 DC/OS Kubernetes 版本，
则强烈建议更新至此版本。如果无法
或者不希望进行更新，则强烈建议用户在更新其集群选项
（例如，在更新分配给 Kubernetes 节点的 RAM 数量之前）之前，
执行一些手动步骤，以避免可能导致
更新操作期间集群停机的行为。这些手动步骤包括：
重新启动框架调度器，确保其从
重新启动中正常恢复，并检测 <code>deploy</code> 计划已达到 <code>COMPLETE</code>
状态。为此，可遵循以下步骤：</p>
<ol>
<li>
<p>强制框架调度器重新启动：</p>
<pre><code>$ dcos marathon app kill /&lt;SERVICE_NAME&gt;
</code></pre>
<p><code>&lt;SERVICE_NAME&gt;</code> 必须替换为服务名称（如
<code>kubernetes</code>).</p>
</li>
<li>
<p>确保框架调度器成功恢复，并且
<code>deploy</code> 计划已完成：</p>
<pre><code>$ dcos kubernetes --name=&lt;SERVICE_NAME&gt; plan show deploy
deploy (serial strategy) (COMPLETE)
(...)
</code></pre>
<p><code>&lt;SERVICE_NAME&gt;</code> 必须替换为服务名称（如
<code>kubernetes</code>)。此命令可能需要几分钟才能开始
产生成功结果。</p>
</li>
</ol>
</article></div><aside class="content__sections"><div class="content__sections-list-container"><ul class="content__sections-list"><li class="content__sections-item content__sections-item--h2"><a href="#在您开始之前">在您开始之前</a></li><li class="content__sections-item content__sections-item--h2"><a href="#-2">更新</a></li><li class="content__sections-item content__sections-item--h2"><a href="#120-1105">更新 1.2.0-1.10.5 之前版本中的包选项</a></li></ul></div></aside></main></div></div><script src="/assets/js/jquery-3.2.1.js"></script><script src="/assets/js/clipboard.js"></script><script src="/assets/js/prism.js"></script><script src="/js/main.js"></script></body></html>