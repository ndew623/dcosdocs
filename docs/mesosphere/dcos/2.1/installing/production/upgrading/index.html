<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width" initial-scale="1" user-scalable="no"><title>Upgrading - D2iQ Docs</title><meta name="description" content="Upgrading a DC/OS cluster"><link rel="apple-touch-icon" sizes="180x180" href="/assets/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/favicon-16x16.png"><link rel="stylesheet" type="text/css" href="/dcosdocs/css/styles.css"><link rel="search" type="application/opensearchdescription+xml" href="/assets/opensearch.xml" title="Search"><link href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,500,500i,700,700i" rel="stylesheet"><script src="https://unpkg.com/feather-icons/dist/feather.min.js"></script><script>window.analytics||(window.analytics=[]),window.analytics.methods=["identify","track","trackLink","trackForm","trackClick","trackSubmit","page","pageview","ab","alias","ready","group","on","once","off"],window.analytics.factory=function(t){return function(){var a=Array.prototype.slice.call(arguments);return a.unshift(t),window.analytics.push(a),window.analytics}};for(var i=0;i<window.analytics.methods.length;i++){var method=window.analytics.methods[i];window.analytics[method]=window.analytics.factory(method)}window.analytics.load=function(t){var a=document.createElement("script");a.type="text/javascript",a.async=!0,a.src=("https:"===document.location.protocol?"https://":"http://")+"d2dq2ahtl5zl1z.cloudfront.net/analytics.js/v1/"+t+"/analytics.min.js";var n=document.getElementsByTagName("script")[0];n.parentNode.insertBefore(a,n)},window.analytics.SNIPPET_VERSION="2.0.8",
window.analytics.load("7sgtwqvuai");
window.analytics.page();</script><noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-PBJ84KX" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript><script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src='//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-PBJ84KX');</script></head><body><div class="layout"><header class="header"><a class="header__drawer"><i class="header__icon" data-feather="menu"></i></a><a class="header__logo" href="/"><img class="header__logo--mobile" src="/assets/D2iQ_Logotype_Color_Positive_Documentation.svg" alt="D2IQ"><img class="header__logo--desktop" src="/assets/D2iQ_Logotype_Color_Positive_Documentation.svg" alt="D2IQ"></a><div class="header__main"><div class="header__dropdown"><img class="header__dropdown-icon" src="/assets/D2IQ_Logotype_Color_Positive.png" alt="D2iQ"><strong>DC/OS Documentation</strong><i data-feather="chevron-down"></i></div><nav class="header__menu"><ul class="header__menu-list"><li class="header__menu-item"><a href="/mesosphere/dcos">DC/OS</a></li><li class="header__menu-item"><a href="/dcosdocs/mesosphere/dcos/services">Services</a></li><li class="header__menu-item"><a href="https://support.d2iq.com">Support</a></li></ul></nav></div><div class="chooser" id="localizer"><div class="chooser-current"><a class="chooser-title">English</a><svg class="chooser-svg" id="localizer-svg"><path class="pointer" d="m 13,6 -5,5 -5,-5 z" fill="#858585"></path></svg></div><ul class="chooser-list" id="localizer-list"><li class="chooser-list-item"><a href="/dcosdocs/mesosphere/dcos/cn/2.1/installing/production/upgrading">中文 (简体)</a></li></ul></div><section class="header__search" role="search"><form class="header__search-form" action="/search/"><input class="header__search-input" id="header-search-input" tabindex="1" type="text" name="q" placeholder="Search"><input type="hidden" name="hFR[scope][0]" value="DC/OS 2.1"><label class="header__search-label" for="header-search-input"><i class="header__icon" data-feather="search"></i></label></form></section></header><div class="header-dropdown"><ul class="header-dropdown__list"><li class="header-dropdown__top-item"><div>DKP</div></li><li class="header-dropdown__item"><a href="/dkp/konvoy">Konvoy</a></li><li class="header-dropdown__item"><a href="/dkp/kommander">Kommander</a></li><li class="header-dropdown__item"><a href="/dkp/dispatch">Dispatch</a></li><li class="header-dropdown__item"><a href="/dkp/kaptain">Kaptain</a></li><li class="header-dropdown__top-item"><div>Mesosphere</div></li><li class="header-dropdown__item header-dropdown__item--active"><a href="/mesosphere/dcos">DC/OS</a></li><li class="header-dropdown__item"><a href="/dcosdocs/mesosphere/dcos/services">DC/OS Services</a></li><li class="header-dropdown__item"><a href="https://support.d2iq.com">Support</a></li></ul></div><div class="layout__sidebar layout__drawer"><section class="sidebar"><header class="sidebar__header"><div class="sidebar__dropdown"><ul><li><a href="/dcosdocs/mesosphere/dcos/2.2/installing/production/upgrading">Mesosphere DC/OS 2.2.0</a></li><li><a href="/dcosdocs/mesosphere/dcos/2.1/installing/production/upgrading">Mesosphere DC/OS 2.1.0</a></li><li><a href="/dcosdocs/mesosphere/dcos/2.0/installing/production/upgrading">Mesosphere DC/OS 2.0</a></li><li><a href="/dcosdocs/mesosphere/dcos/1.13/installing/production/upgrading">Mesosphere DC/OS 1.13</a></li></ul><div class="toggle"><p><span class="title">DC/OS</span><span class="version"> 2.1</span></p><i data-feather="chevron-down"></i></div></div></header><nav class="sidebar_nav" role="navigation"><ul><li><a class="d0" href="/dcosdocs/mesosphere/dcos/2.1/release-notes/"><i data-feather="chevron-right"></i>Release Notes</a></li><li><a class="d0" href="/dcosdocs/mesosphere/dcos/2.1/overview/"><i data-feather="chevron-right"></i>Overview</a></li><li class="active"><a class="d0" href="/dcosdocs/mesosphere/dcos/2.1/installing/"><i data-feather="chevron-right"></i>Installing</a></li><ul><li><a class="d1" href="/dcosdocs/mesosphere/dcos/2.1/installing/evaluation/"><i data-feather="chevron-right"></i>Cloud Installation</a></li><li class="active"><a class="d1" href="/dcosdocs/mesosphere/dcos/2.1/installing/production/"><i data-feather="chevron-right"></i>On-Prem Installation</a></li><ul><li><a class="d2" href="/dcosdocs/mesosphere/dcos/2.1/installing/production/virt-infra/">Virtual Infrastructure</a></li><li><a class="d2" href="/dcosdocs/mesosphere/dcos/2.1/installing/production/system-requirements/"><i data-feather="chevron-right"></i>System Requirements</a></li><li><a class="d2" href="/dcosdocs/mesosphere/dcos/2.1/installing/production/deploying-dcos/"><i data-feather="chevron-right"></i>Deploying DC/OS</a></li><li><a class="d2" href="/dcosdocs/mesosphere/dcos/2.1/installing/production/advanced-configuration/"><i data-feather="chevron-right"></i>Advanced Configuration</a></li><li><a class="d2" href="/dcosdocs/mesosphere/dcos/2.1/installing/production/dcos-ansible/"><i data-feather="chevron-right"></i>DC/OS with Ansible</a></li><li><a class="d2" href="/dcosdocs/mesosphere/dcos/2.1/installing/production/patching/">Patching</a></li><li class="active active-on"><a class="d2" href="/dcosdocs/mesosphere/dcos/2.1/installing/production/upgrading/">Upgrading</a></li><li><a class="d2" href="/dcosdocs/mesosphere/dcos/2.1/installing/production/uninstalling/">Uninstalling</a></li></ul><li><a class="d1" href="/dcosdocs/mesosphere/dcos/2.1/installing/installation-faq/">Frequently Asked Questions</a></li><li><a class="d1" href="/dcosdocs/mesosphere/dcos/2.1/installing/troubleshooting/">Troubleshooting</a></li></ul><li><a class="d0" href="/dcosdocs/mesosphere/dcos/2.1/gui/"><i data-feather="chevron-right"></i>GUI</a></li><li><a class="d0" href="/dcosdocs/mesosphere/dcos/2.1/cli/"><i data-feather="chevron-right"></i>CLI</a></li><li><a class="d0" href="/dcosdocs/mesosphere/dcos/2.1/administering-clusters/"><i data-feather="chevron-right"></i>Administering Clusters</a></li><li><a class="d0" href="/dcosdocs/mesosphere/dcos/2.1/networking/"><i data-feather="chevron-right"></i>Networking</a></li><li><a class="d0" href="/dcosdocs/mesosphere/dcos/2.1/security/"><i data-feather="chevron-right"></i>Security</a></li><li><a class="d0" href="/dcosdocs/mesosphere/dcos/2.1/storage/"><i data-feather="chevron-right"></i>Storage</a></li><li><a class="d0" href="/dcosdocs/mesosphere/dcos/2.1/metrics/"><i data-feather="chevron-right"></i>Metrics</a></li><li><a class="d0" href="/dcosdocs/mesosphere/dcos/2.1/monitoring/"><i data-feather="chevron-right"></i>Monitoring, Logging, and Debugging</a></li><li><a class="d0" href="/dcosdocs/mesosphere/dcos/2.1/multi-tenancy/"><i data-feather="chevron-right"></i>Multi-Tenancy for DC/OS Clusters</a></li><li><a class="d0" href="/dcosdocs/mesosphere/dcos/2.1/hybrid-cloud/"><i data-feather="chevron-right"></i>Hybrid Cloud</a></li><li><a class="d0" href="/dcosdocs/mesosphere/dcos/2.1/deploying-jobs/"><i data-feather="chevron-right"></i>Deploying Jobs</a></li><li><a class="d0" href="/dcosdocs/mesosphere/dcos/2.1/deploying-services/"><i data-feather="chevron-right"></i>Deploying Services and Pods</a></li><li><a class="d0" href="/dcosdocs/mesosphere/dcos/2.1/tutorials/"><i data-feather="chevron-right"></i>Tutorials</a></li><li><a class="d0" href="/dcosdocs/mesosphere/dcos/2.1/api/"><i data-feather="chevron-right"></i>API Reference</a></li><li><a class="d0" href="/dcosdocs/mesosphere/dcos/2.1/developing-services/"><i data-feather="chevron-right"></i>Developing DC/OS Services</a></li></ul></nav><footer class="sidebar__footer"><div class="sidebar__footer-links"><a href="https://d2iq.com/terms/">Terms of Service</a><a href="https://d2iq.com/privacy/">Privacy Policy</a></div><a class="sidebar__footer-copyright" href="https://d2iq.com/">&copy; 2022 D2iQ, Inc. All rights reserved.</a></footer></section></div><div class="layout__content" role="main"><main class="content"><div class="content__container content__container--with-sections"><div class="content__header"><div class="content__header__row"><h1 class="content__header-title">Upgrading</h1></div><h4 class="content__header-description">Upgrading a DC/OS cluster</h4><div class="actions"><ul class="actions__list"><li class="actions__item"><button class="actions__link" onclick="javascript:window.print()"><i class="actions__icon" data-feather="printer"></i><span class="actions__text">Print</span></button></li><li class="actions__item"><a class="actions__link" href="https://github.com/mesosphere/dcos-docs-site/tree/main/pages/dcosdocs/mesosphere/dcos/2.1/installing/production/upgrading/index.md" target="_blank"><i class="actions__icon" data-feather="github"></i><span class="actions__text">Contribute</span></a></li></ul></div></div><article class="content__article"><p>An upgrade is the process of moving between major releases to add new features or to replace existing features with new features/functionality. You can upgrade DC/OS only if you have used the advanced installation process to install DC/OS on your cluster.</p>
<p class="message--important"><strong>IMPORTANT: </strong>An upgrade is required only when changing the major or minor version of your DC/OS installation. Example: 2.0 --> 2.1</p>
<ul>
<li>To update to a newer maintenance version (e.g. 2.0.2 to 2.0.4), refer to the instructions for <a href="/dcosdocs/mesosphere/dcos/2.1/installing/production/patching/">patching</a>.</li>
<li>To modify the cluster configuration, refer to the instructions for <a href="/dcosdocs/mesosphere/dcos/2.1/installing/production/patching/">patching</a>.</li>
</ul>
<p>If upgrading is performed on a supported OS with all prerequisites fulfilled, then the upgrade <strong>should</strong> preserve the state of running tasks on the cluster.</p>
<h2 id="important-guidelines"><a class="content__anchor" href="#important-guidelines" aria-hidden="true"><i data-feather="bookmark"></i></a>Important guidelines</h2>
<ul>
<li>The Production installation method is the <strong>only</strong> recommended upgrade path for DC/OS. It is recommended that you familiarize yourself with the <a href="/dcosdocs/mesosphere/dcos/2.1/installing/production/deploying-dcos/">DC/OS Deployment Guide</a> before proceeding.</li>
<li>Review the <a href="/dcosdocs/mesosphere/dcos/2.1/release-notes/">release notes</a> before upgrading DC/OS.</li>
<li>Due to a cluster configuration issue with overlay networks, it is recommended to set <code>enable_ipv6</code> to false in <code>config.yaml</code> when upgrading or configuring a new cluster.  You can find additional information and a more detailed remediation procedure in our latest critical <a href="https://support.mesosphere.com/s/article/Critical-Issue-with-Overlay-Networking">product advisory</a>. <span class="badge__container badge__container--inline"><span class="badge badge--shortcode badge--small badge--inline badge--enterprise">Enterprise</span></span></li>
<li>If IPv6 is disabled in the kernel, then IPv6 must be disabled in the <code>config.yaml</code> file.</li>
<li>The DC/OS Enterprise license key must reside in a <code>genconf/license.txt</code> file. <span class="badge__container badge__container--inline"><span class="badge badge--shortcode badge--small badge--inline badge--enterprise">Enterprise</span></span></li>
<li>The DC/OS GUI and other higher-level system APIs may be inconsistent or unavailable until all master nodes have been upgraded.
When this occurs:
<ul>
<li>The DC/OS GUI may not provide an accurate list of services.</li>
</ul>
</li>
<li>An upgraded DC/OS Marathon leader cannot connect to the leading Mesos master until it has also been upgraded. The DC/OS UI cannot be trusted until all masters are upgraded. There are multiple Marathon scheduler instances and multiple Mesos masters, each being upgraded, and the Marathon leader may not be the Mesos leader.</li>
<li>Task history in the Mesos UI will not persist through the upgrade.</li>
<li>DC/OS 2.0 added TLS for Exhibitor.  Exhibitor TLS is automatically enabled for static master clusters during installation of DC/OS 2.0 or later. It is not enabled during an upgrade from DC/OS 1.13 or earlier.  Once the cluster has been upgraded to DC/OS 2.0 or later, <a href="/dcosdocs/mesosphere/dcos/2.1/security/ent/tls-ssl/exhibitor">Exhibitor can be manually configured to use TLS</a>.  <span class="badge__container badge__container--inline"><span class="badge badge--shortcode badge--small badge--inline badge--enterprise">Enterprise</span></span></li>
</ul>
<h2 id="supported-upgrade-paths"><a class="content__anchor" href="#supported-upgrade-paths" aria-hidden="true"><i data-feather="bookmark"></i></a>Supported upgrade paths</h2>
<p>The following tables list the supported upgrade paths for DC/OS 2.1.</p>
<table>
<thead>
<tr>
<th><strong>Display Icon</strong></th>
<th><strong>Service</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>⚫</td>
<td>Supported</td>
</tr>
<tr>
<td>◯</td>
<td>Not Supported</td>
</tr>
</tbody>
</table>
<table style="border-collapse: collapse;" Border = "1" Cellpadding = "5" Cellspacing = "5">
   <caption>DC/OS 1.13 to 2.1 Upgrade Paths</caption>
   <tr>
    <th Rowspan = "20" Align = "center"><strong>Upgrade<br>From</strong></th>
   <tr>
    <th></th>
    <th Colspan = "20" Align = "center"><strong>Upgrade To</strong></th>
   </tr>
    <th></th>
    <th Align = "center">2.1.0</th>
    <th Align = "center">2.1.1</th>
   </tr>
   <tr>
    <th>1.13.0</th>
    <td Align = "center">◯</td>
    <td Align = "center">◯</td>
   </tr>
   <tr>
    <th>1.13.1</th>
    <td Align = "center">◯</td>
    <td Align = "center">◯</td>
   </tr>
   <tr>
    <th>1.13.2</th>
    <td Align = "center">◯</td>
    <td Align = "center">◯</td>
   </tr>
   <tr>
    <th>1.13.3</th>
    <td Align = "center">◯</td>
    <td Align = "center">◯</td>
   </tr>
   <tr>
    <th>1.13.4</th>
    <td Align = "center">◯</td>
    <td Align = "center">◯</td>
   </tr>
   <tr>
    <th>1.13.5</th>
    <td Align = "center">◯</td>
    <td Align = "center">◯</td>
   </tr>
   <tr>
    <th>1.13.6</th>
    <td Align = "center">⚫</td>
    <td Align = "center">⚫</td>
   </tr>
   <tr>
    <th>1.13.7</th>
    <td Align = "center">⚫</td>
    <td Align = "center">⚫</td>
   </tr>
   <tr>
    <th>1.13.9</th>
    <td Align = "center">⚫</td>
    <td Align = "center">⚫</td>
   </tr>
   <tr>
    <th>1.13.10</th>
    <td Align = "center">⚫</td>
    <td Align = "center">⚫</td>
   </tr>
</table>
<br>
<table style="border-collapse: collapse;" Border = "1" Cellpadding = "5" Cellspacing = "5">
   <caption>DC/OS 2.0 to 2.1 Upgrade Paths</caption>
   <tr>
    <th Rowspan = "20" Align = "center"><strong>Upgrade<br>From</strong></th>
   <tr>
    <th></th>
    <th Colspan = "20" Align = "center"><strong>Upgrade To</strong></th>
   </tr>
    <th></th>
    <th Align = "center">2.1.0</th>
    <th Align = "center">2.1.1</th>
   </tr>
   <tr>
    <th>2.0.0</th>
    <td Align = "center">⚫</td>
    <td Align = "center">◯</td>
   </tr>
   <tr>
    <th>2.0.1</th>
    <td Align = "center">⚫</td>
    <td Align = "center">◯</td>
   </tr>
   <tr>
    <th>2.0.2</th>
    <td Align = "center">⚫</td>
    <td Align = "center">◯</td>
   </tr>
   <tr>
    <th>2.0.3</th>
    <td Align = "center">⚫</td>
    <td Align = "center">◯</td>
   </tr>
   <tr>
    <th>2.0.4</th>
    <td Align = "center">⚫</td>
    <td Align = "center">⚫</td>
   </tr>
   <tr>
    <th>2.0.5</th>
    <td Align = "center">⚫</td>
    <td Align = "center">⚫</td>
   </tr>
   <tr>
    <th>2.0.6</th>
    <td Align = "center">⚫</td>
    <td Align = "center">⚫</td>
   </tr>
  </table>
<h1 id="modifying-dcos-configuration-enterprise"><a class="content__anchor" href="#modifying-dcos-configuration-enterprise" aria-hidden="true"><i data-feather="bookmark"></i></a>Modifying DC/OS configuration <span class="badge__container badge__container--inline"><span class="badge badge--shortcode badge--small badge--inline badge--enterprise">Enterprise</span></span></h1>
<p>You <strong>cannot</strong> change your cluster configuration at the same time as upgrading to a new version. Cluster configuration changes must be done with a patch to an already installed version. For example, you cannot simultaneously upgrade a cluster from 2.0 to 2.1 and add more public agents. You can add more public agents with a patch to 2.0 and then upgrade to 2.1, or you can upgrade to 2.1 and then add more public agents by <a href="/dcosdocs/mesosphere/dcos/2.1/installing/production/patching/">patching 2.1</a> after the upgrade.</p>
<h1 id="instructions"><a class="content__anchor" href="#instructions" aria-hidden="true"><i data-feather="bookmark"></i></a>Instructions</h1>
<p>These steps must be performed for version upgrades.</p>
<h2 id="prerequisites"><a class="content__anchor" href="#prerequisites" aria-hidden="true"><i data-feather="bookmark"></i></a>Prerequisites</h2>
<ul>
<li>Enterprise users: DC/OS Enterprise downloads can be found <a href="https://support.mesosphere.com/hc/en-us/articles/213198586-Mesosphere-Enterprise-DC-OS-Downloads">here</a>. <span class="badge__container badge__container--inline"><span class="badge badge--shortcode badge--small badge--inline badge--enterprise">Enterprise</span></span></li>
<li>Open Source users: DC/OS Open Source downloads can be found <a href="https://dcos.io/releases/">here</a>. <span class="badge__container badge__container--inline"><span class="badge badge--shortcode badge--small badge--inline badge--oss">Open Source</span></span></li>
<li>Mesos, Mesos Frameworks, Marathon, Docker and all running tasks in the cluster should be stable and in a known healthy state.</li>
<li>For Mesos compatibility reasons, we recommend upgrading any running Marathon-on-Marathon instances to Marathon version 1.3.5 before proceeding with this DC/OS upgrade.</li>
<li>You must have access to copies of the config files used with the previous DC/OS version: <code>config.yaml</code> and <code>ip-detect</code>.</li>
<li>You must be using systemd 218 or newer to maintain task state.</li>
<li>All hosts (masters and agents) must be able to communicate with all other hosts as described at <a href="/dcosdocs/mesosphere/dcos/2.1/administering-clusters/securing-your-cluster/#network-security">network security</a>.</li>
<li>In CentOS or RedHat, install IP sets with this command (used in some IP detect scripts): <code>sudo yum install -y ipset</code></li>
<li>You must be familiar with using <code>systemctl</code> and <code>journalctl</code> command line tools to review and monitor service status. Troubleshooting notes can be found at the end of this <a href="#troubleshooting">document</a>.</li>
<li>You must be familiar with the DC/OS <a href="/dcosdocs/mesosphere/dcos/2.1/installing/production/deploying-dcos/installation/#custom-build-file">Production Installation</a> instructions.</li>
<li>Take a <a href="/dcosdocs/mesosphere/dcos/2.1/installing/installation-faq/#q-how-do-i-backup-zookeeper-using-guano">snapshot of ZooKeeper</a> prior to upgrading. Marathon supports rollbacks, but does not support downgrades.</li>
<li>Take a <a href="/dcosdocs/mesosphere/dcos/2.1/installing/installation-faq/#q-how-do-i-backup-the-iam-database-enterprise">snapshot of the IAM database</a> prior to upgrading. <strong>This is very easy to do and should be considered a necessity.</strong></li>
<li>Ensure that Marathon event subscribers are disabled before beginning the upgrade. Leave them disabled after completing the upgrade, as this feature is now deprecated.</li>
</ul>
<p class="message--note"><strong>NOTE: </strong>Marathon event subscribers are disabled by default. Check to see if the line <code>--event_subscriber "http_callback"</code> has been added to <code>sudo vi /opt/mesosphere/bin/marathon.sh</code> on your master node(s). In such a case, you must remove that line in order to disable event subscribers.</p>
<p><span class="badge__container badge__container--inline"><span class="badge badge--shortcode badge--small badge--inline badge--enterprise">Enterprise</span></span></p>
<ul>
<li>Verify that all Marathon application constraints are valid before beginning the upgrade. Use <a href="https://github.com/mesosphere/public-support-tools/blob/master/check-constraints.py">this script</a> to check if your constraints are valid.</li>
<li><a href="/dcosdocs/mesosphere/dcos/2.1/administering-clusters/backup-and-restore/">Back up your cluster</a>. <span class="badge__container badge__container--inline"><span class="badge badge--shortcode badge--small badge--inline badge--enterprise">Enterprise</span></span></li>
<li>Optional: You can add custom <a href="/dcosdocs/mesosphere/dcos/2.1/installing/production/deploying-dcos/node-cluster-health-check/">node and cluster health checks</a> to your <code>config.yaml</code>.</li>
<li>Verify that all your masters are in a healthy state:
<ul>
<li>Check the Exhibitor UI to confirm that all masters have joined the quorum successfully (the status indicator will show green). The Exhibitor UI is available at <code>http://&lt;dcos_master&gt;:8181/</code>.</li>
<li>Verify that <code>curl http://&lt;dcos_master_private_ip&gt;:5050/metrics/snapshot</code> has the metric <code>registrar/log/recovered</code> with a value of <code>1</code> for each master.</li>
</ul>
</li>
</ul>
<h2 id="bootstrap-node"><a class="content__anchor" href="#bootstrap-node" aria-hidden="true"><i data-feather="bookmark"></i></a>Bootstrap Node</h2>
<p>This procedure upgrades a DC/OS 2.0 cluster to DC/OS 2.1.</p>
<ol>
<li>
<p>Copy your existing <code>config.yaml</code> and <code>ip-detect</code> files to an empty <code>genconf</code> folder on your bootstrap node. The folder should be in the same directory as the installer.</p>
</li>
<li>
<p>The syntax of the <code>config.yaml</code> file can be different from the earlier version. For a detailed description of the current <code>config.yaml</code> syntax and parameters, see the <a href="/dcosdocs/mesosphere/dcos/2.1/installing/production/advanced-configuration/configuration-reference/">documentation</a>.</p>
<ul>
<li>You cannot change the <code>exhibitor_storage_backend</code> setting during an upgrade.</li>
</ul>
</li>
<li>
<p>After updating the <code>config.yaml</code>, compare the old <code>config.yaml</code> and new <code>config.yaml</code>. Verify that there are no differences in pathways or configurations. Changing these while upgrading can lead to catastrophic cluster failures.</p>
</li>
<li>
<p>Modify the <code>ip-detect</code> file if necessary.</p>
</li>
<li>
<p>Build your installer package.</p>
<ol>
<li>
<p>Download the <code>dcos_generate_config.ee.sh</code> <span class="badge__container badge__container--inline"><span class="badge badge--shortcode badge--small badge--inline badge--enterprise">Enterprise</span></span> or <code>dcos_generate_config.sh</code> <span class="badge__container badge__container--inline"><span class="badge badge--shortcode badge--small badge--inline badge--oss">Open Source</span></span> file.</p>
</li>
<li>
<p>Generate the installation files. Replace <code>&lt;installed_cluster_version&gt;</code> in the below command with the DC/OS version currently running on the cluster you intend to upgrade, for example <code>2.0.4</code>.</p>
<p><span class="badge__container badge__container--inline"><span class="badge badge--shortcode badge--small badge--inline badge--enterprise">Enterprise</span></span></p>
<pre><code class="language-bash">dcos_generate_config.ee.sh --generate-node-upgrade-script &lt;installed_cluster_version&gt;
</code></pre>
<p><span class="badge__container badge__container--inline"><span class="badge badge--shortcode badge--small badge--inline badge--oss">Open Source</span></span></p>
<pre><code class="language-bash">dcos_generate_config.sh --generate-node-upgrade-script &lt;installed_cluster_version&gt;
</code></pre>
</li>
<li>
<p>The command in the previous step will produce a URL in the last line of its output, prefixed with <code>Node upgrade script URL:</code>. Record this URL for use in later steps. It will be referred to in this document as the “Node upgrade script URL”.</p>
</li>
</ol>
</li>
<li>
<p>Run the nginx container to serve the <a href="/dcosdocs/mesosphere/dcos/2.1/installing/production/deploying-dcos/installation/#custom-build-file">installation files</a> using the Docker <a href="/dcosdocs/mesosphere/dcos/2.1/installing/production/deploying-dcos/installation/#nginx-cmd">run</a> command. For <code>&lt;your-port&gt;</code>, specify the port value that is used in the Node upgrade script URL.</p>
</li>
</ol>
<pre><code class="language-bash">sudo docker run -d -p &lt;your-port&gt;:80 -v $PWD/genconf/serve:/usr/share/nginx/html:ro nginx
</code></pre>
<ol start="7">
<li>Go to the DC/OS Master <a href="#masters">procedure</a> to complete your installation.</li>
</ol>
<h2 id="dcos-masters"><a class="content__anchor" href="#dcos-masters" aria-hidden="true"><i data-feather="bookmark"></i></a><a name="masters"></a>DC/OS Masters</h2>
<p>Proceed with upgrading every master node one at a time in any order using the following procedure. When you complete each upgrade, monitor the Mesos master metrics to ensure the node has rejoined the cluster and completed reconciliation.</p>
<ol>
<li>
<p>Download and run the node upgrade script:</p>
<pre><code class="language-bash">curl -O &lt;Node upgrade script URL&gt;
sudo bash dcos_node_upgrade.sh
</code></pre>
</li>
<li>
<p>Verify that the upgrade script succeeded and exited with the status code <code>0</code>:</p>
<pre><code class="language-bash">echo $?
0
</code></pre>
</li>
<li>
<p>Validate the upgrade by running the following commands on the master node:</p>
<ol>
<li>
<p>Monitor Exhibitor and wait for it to converge.</p>
<p>On DC/OS Enterprise clusters with a static master list use the command:</p>
<pre><code class="language-bash">sudo curl --cacert /var/lib/dcos/exhibitor-tls-artifacts/root-cert.pem --cert /var/lib/dcos/exhibitor-tls-artifacts/client-cert.pem --key /var/lib/dcos/exhibitor-tls-artifacts/client-key.pem https://localhost:8181/exhibitor/v1/cluster/status
</code></pre>
<p>On other clusters use the command:</p>
<pre><code class="language-bash">curl http://localhost:8181/exhibitor/v1/cluster/status
</code></pre>
<p>Wait until the response shows that all hosts have <code>&quot;description&quot;:&quot;serving&quot;</code>.</p>
</li>
<li>
<p>Wait until the <code>dcos-mesos-master</code> unit is up and running.</p>
</li>
<li>
<p>Verify that <code>curl http://localhost:5050/metrics/snapshot</code> has the metric <code>registrar/log/recovered</code> with a value of <code>1</code>.</p>
<p class="message--note"><strong>NOTE: </strong>If you are upgrading from permissive to strict mode, this URL will be <code>curl https://...</code> and you will need a JWT for access. </p>
<span class="badge__container badge__container--inline"><span class="badge badge--shortcode badge--small badge--inline badge--enterprise">Enterprise</span></span>
</li>
</ol>
</li>
<li>
<p>Verify that <code>/opt/mesosphere/bin/mesos-master --version</code> indicates that the upgraded master is running the version of Mesos specified in the <a href="/dcosdocs/mesosphere/dcos/2.1/release-notes/">release notes</a>, for example <code>1.9.1</code>.</p>
<ol>
<li>Verify that the number of under-replicated ranges in CockroachDB has dropped to zero as the IAM database is replicated to the new master. Run the following command and confirm that the <code>ranges_underreplicated</code> column shows only zeros.</li>
</ol>
<pre><code class="language-bash">sudo /opt/mesosphere/bin/cockroach node status --ranges --certs-dir=/run/dcos/pki/bouncer --host=$(/opt/mesosphere/bin/detect_ip)
</code></pre>
<pre><code>+----+---------------------+--------+---------------------+---------------------+------------------+-----------------------+--------+--------------------+------------------------+
| id |       address       | build  |     updated_at      |     started_at      | replicas_leaders | replicas_leaseholders | ranges | ranges_unavailable | ranges_underreplicated |
+----+---------------------+--------+---------------------+---------------------+------------------+-----------------------+--------+--------------------+------------------------+
|  1 | 172.31.7.32:26257   | v1.1.4 | 2018-03-08 13:56:10 | 2018-02-28 20:11:00 |              195 |                   194 |    195 |                  0 |                      0 |
|  2 | 172.31.10.48:26257  | v1.1.4 | 2018-03-08 13:56:05 | 2018-03-05 13:33:45 |              200 |                   199 |    200 |                  0 |                      0 |
|  3 | 172.31.23.132:26257 | v1.1.4 | 2018-03-08 13:56:01 | 2018-02-28 20:18:41 |              187 |                   187 |    187 |                  0 |                      0 |
+----+---------------------+--------+---------------------+---------------------+------------------+-----------------------+--------+--------------------+------------------------+
</code></pre>
<p>If the <code>ranges_underreplicated</code> column lists any non-zero values, wait a minute and rerun the command. The values will converge to zero after all data is safely replicated.</p>
</li>
<li>
<p>Go to the DC/OS Agents <a href="#agents">procedure</a> to complete your installation.</p>
</li>
</ol>
<h2 id="dcos-agents"><a class="content__anchor" href="#dcos-agents" aria-hidden="true"><i data-feather="bookmark"></i></a><a name="agents"></a>DC/OS Agents</h2>
<p>Be aware that when upgrading agent nodes, there is a five minute timeout for the agent to respond to health check pings from the mesos-masters before the agent nodes and task expire.</p>
<p>On all DC/OS agents:</p>
<ol>
<li>
<p>Navigate to the <code>/opt/mesosphere/lib</code> directory and delete this library file. Deleting this file will prevent conflicts.</p>
<pre><code class="language-bash">  libltdl.so.7
</code></pre>
</li>
<li>
<p>Download and run the node upgrade script.</p>
<pre><code class="language-bash">curl -O &lt;Node upgrade script URL&gt;
sudo bash dcos_node_upgrade.sh
</code></pre>
</li>
<li>
<p>Verify that the upgrade script succeeded and exited with the status code <code>0</code>.</p>
<pre><code class="language-bash">echo $?
0
</code></pre>
</li>
<li>
<p>Validate the upgrade.</p>
<ul>
<li>Verify that <code>curl http://&lt;dcos_agent_private_ip&gt;:5051/metrics/snapshot</code> has the metric <code>slave/registered</code> with a value of <code>1</code>.</li>
<li>Monitor the Mesos UI to verify that the upgraded node rejoins the DC/OS cluster and that tasks are reconciled (<code>http://&lt;master-ip&gt;/mesos</code>).
If you are upgrading from permissive to strict mode, this URL will be <code>https://&lt;master-ip&gt;/mesos</code>.</li>
</ul>
</li>
</ol>
<h2 id="troubleshooting-recommendations"><a class="content__anchor" href="#troubleshooting-recommendations" aria-hidden="true"><i data-feather="bookmark"></i></a><a name="troubleshooting"></a>Troubleshooting Recommendations</h2>
<p>The following commands should provide insight into upgrade issues:</p>
<h3 id="on-all-cluster-nodes"><a class="content__anchor" href="#on-all-cluster-nodes" aria-hidden="true"><i data-feather="bookmark"></i></a>On All Cluster Nodes</h3>
<pre><code class="language-bash">sudo journalctl -u dcos-download
sudo journalctl -u dcos-spartan
sudo systemctl | grep dcos
</code></pre>
<p>If your upgrade fails because of a <a href="/dcosdocs/mesosphere/dcos/2.1/installing/production/deploying-dcos/node-cluster-health-check/">custom node or cluster check</a>, run these commands for more details:</p>
<pre><code class="language-bash">dcos-check-runner check node-poststart
dcos-check-runner check cluster
</code></pre>
<h3 id="on-dcos-masters"><a class="content__anchor" href="#on-dcos-masters" aria-hidden="true"><i data-feather="bookmark"></i></a>On DC/OS Masters</h3>
<p><span class="badge__container badge__container--inline"><span class="badge badge--shortcode badge--small badge--inline badge--enterprise">Enterprise</span></span></p>
<pre><code class="language-bash">sudo journalctl -u dcos-exhibitor
less /opt/mesosphere/active/exhibitor/usr/zookeeper/zookeeper.out
sudo journalctl -u dcos-mesos-dns
sudo journalctl -u dcos-mesos-master
</code></pre>
<p><span class="badge__container badge__container--inline"><span class="badge badge--shortcode badge--small badge--inline badge--oss">Open Source</span></span></p>
<pre><code class="language-bash">sudo journalctl -u dcos-exhibitor
less /var/lib/dcos/exhibitor/zookeeper/zookeeper.out
sudo journalctl -u dcos-mesos-dns
sudo journalctl -u dcos-mesos-master
</code></pre>
<h3 id="on-dcos-agents"><a class="content__anchor" href="#on-dcos-agents" aria-hidden="true"><i data-feather="bookmark"></i></a>On DC/OS Agents</h3>
<pre><code class="language-bash">sudo journalctl -u dcos-mesos-slave
</code></pre>
<h2 id="notes"><a class="content__anchor" href="#notes" aria-hidden="true"><i data-feather="bookmark"></i></a>Notes:</h2>
<ul>
<li>Packages available in the DC/OS 2.1 Catalog are newer than those in the older versions of Catalog. Services are not automatically upgraded when DC/OS is installed because not all DC/OS services have upgrade paths that will preserve existing states.</li>
</ul>
</article></div><aside class="content__sections"><div class="content__sections-list-container"><ul class="content__sections-list"><li class="content__sections-item content__sections-item--h2"><a href="#important-guidelines">Important guidelines</a></li><li class="content__sections-item content__sections-item--h2"><a href="#supported-upgrade-paths">Supported upgrade paths</a></li><li class="content__sections-item content__sections-item--h1"><a href="#modifying-dcos-configuration-enterprise">Modifying DC/OS configuration Enterprise</a></li><li class="content__sections-item content__sections-item--h1"><a href="#instructions">Instructions</a></li><li class="content__sections-item content__sections-item--h2"><a href="#prerequisites">Prerequisites</a></li><li class="content__sections-item content__sections-item--h2"><a href="#bootstrap-node">Bootstrap Node</a></li><li class="content__sections-item content__sections-item--h2"><a href="#dcos-masters">DC/OS Masters</a></li><li class="content__sections-item content__sections-item--h2"><a href="#dcos-agents">DC/OS Agents</a></li><li class="content__sections-item content__sections-item--h2"><a href="#troubleshooting-recommendations">Troubleshooting Recommendations</a></li><li class="content__sections-item content__sections-item--h2"><a href="#notes">Notes:</a></li></ul></div></aside></main></div></div><script src="/assets/js/jquery-3.2.1.js"></script><script src="/assets/js/clipboard.js"></script><script src="/assets/js/prism.js"></script><script src="/js/main.js"></script></body></html>