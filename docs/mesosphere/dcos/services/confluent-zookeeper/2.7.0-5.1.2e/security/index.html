<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width" initial-scale="1" user-scalable="no"><title>Security - D2iQ Docs</title><meta name="description" content="# DC/OS Confluent ZooKeeper Security"><link rel="apple-touch-icon" sizes="180x180" href="/assets/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/favicon-16x16.png"><link rel="stylesheet" type="text/css" href="/dcosdocs/css/styles.css"><link rel="search" type="application/opensearchdescription+xml" href="/assets/opensearch.xml" title="Search"><link href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,500,500i,700,700i" rel="stylesheet"><script src="https://unpkg.com/feather-icons/dist/feather.min.js"></script><script>window.analytics||(window.analytics=[]),window.analytics.methods=["identify","track","trackLink","trackForm","trackClick","trackSubmit","page","pageview","ab","alias","ready","group","on","once","off"],window.analytics.factory=function(t){return function(){var a=Array.prototype.slice.call(arguments);return a.unshift(t),window.analytics.push(a),window.analytics}};for(var i=0;i<window.analytics.methods.length;i++){var method=window.analytics.methods[i];window.analytics[method]=window.analytics.factory(method)}window.analytics.load=function(t){var a=document.createElement("script");a.type="text/javascript",a.async=!0,a.src=("https:"===document.location.protocol?"https://":"http://")+"d2dq2ahtl5zl1z.cloudfront.net/analytics.js/v1/"+t+"/analytics.min.js";var n=document.getElementsByTagName("script")[0];n.parentNode.insertBefore(a,n)},window.analytics.SNIPPET_VERSION="2.0.8",
window.analytics.load("7sgtwqvuai");
window.analytics.page();</script><noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-PBJ84KX" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript><script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src='//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-PBJ84KX');</script></head><body><div class="layout"><header class="header"><a class="header__drawer"><i class="header__icon" data-feather="menu"></i></a><a class="header__logo" href="/"><img class="header__logo--mobile" src="/assets/D2iQ_Logotype_Color_Positive_Documentation.svg" alt="D2IQ"><img class="header__logo--desktop" src="/assets/D2iQ_Logotype_Color_Positive_Documentation.svg" alt="D2IQ"></a><div class="header__main"><div class="header__dropdown"><img class="header__dropdown-icon" src="/assets/D2IQ_Logotype_Color_Positive.png" alt="D2iQ"><strong>Confluent Zookeeper Documentation</strong><i data-feather="chevron-down"></i></div><nav class="header__menu"><ul class="header__menu-list"><li class="header__menu-item"><a href="https://support.d2iq.com">Support</a></li></ul></nav></div><div class="chooser" id="spherer"><div class="chooser-current"><a class="chooser-title">Mesosphere</a><svg class="chooser-svg" id="spherer-svg"><path class="pointer" d="m 13,6 -5,5 -5,-5 z" fill="#858585"></path></svg></div><ul class="chooser-list" id="spherer-list"><li class="chooser-list-item"><a href="/mesosphere/dcos">DC/OS</a></li><li class="chooser-list-item"><a href="/dcosdocs/mesosphere/dcos/services">DC/OS Services</a></li></ul></div><div class="chooser" id="ks"><div class="chooser-current"><a class="chooser-title">DKP</a><svg class="chooser-svg" id="kspherer-svg"><path class="pointer" d="m 13,6 -5,5 -5,-5 z" fill="#858585"></path></svg></div><ul class="chooser-list" id="kspherer-list"><li class="chooser-list-item"><a href="/dkp/konvoy">Konvoy</a></li><li class="chooser-list-item"><a href="/dkp/konvoy/partner-solutions">Partner Solutions</a></li><li class="chooser-list-item"><a href="/dkp/kommander">Kommander</a></li><li class="chooser-list-item"><a href="/dkp/dispatch">Dispatch</a></li><li class="chooser-list-item"><a href="/dkp/kaptain">Kaptain</a></li></ul></div><div class="chooser" id="localizer"><div class="chooser-current"><a class="chooser-title">English</a><svg class="chooser-svg" id="localizer-svg"><path class="pointer" d="m 13,6 -5,5 -5,-5 z" fill="#858585"></path></svg></div><ul class="chooser-list" id="localizer-list"><li class="chooser-list-item"><a href="/dcosdocs/mesosphere/dcos/cn/services">中文 (简体)</a></li></ul></div><section class="header__search" role="search"><form class="header__search-form" action="/search/"><input class="header__search-input" id="header-search-input" tabindex="1" type="text" name="q" placeholder="Search"><input type="hidden" name="hFR[scope][0]" value="DC/OS Services"><label class="header__search-label" for="header-search-input"><i class="header__icon" data-feather="search"></i></label></form></section></header><div class="header-dropdown"><ul class="header-dropdown__list"><li class="header-dropdown__top-item"><div>DKP</div></li><li class="header-dropdown__item"><a href="/dkp/konvoy">Konvoy</a></li><li class="header-dropdown__item"><a href="/dkp/konvoy/partner-solutions">Partner Solutions</a></li><li class="header-dropdown__item"><a href="/dkp/kommander">Kommander</a></li><li class="header-dropdown__item"><a href="/dkp/dispatch">Dispatch</a></li><li class="header-dropdown__item"><a href="/dkp/kaptain">Kaptain</a></li><li class="header-dropdown__top-item"><div>Mesosphere</div></li><li class="header-dropdown__item header-dropdown__item--active"><a href="/mesosphere/dcos">DC/OS</a></li><li class="header-dropdown__item header-dropdown__item--active"><a href="/dcosdocs/mesosphere/dcos/services">DC/OS Services</a></li><li class="header-dropdown__item"><a href="https://support.d2iq.com">Support</a></li></ul></div><div class="layout__sidebar layout__drawer"><section class="sidebar"><header class="sidebar__header"><div class="sidebar__dropdown"><ul><li><a href="/dcosdocs/mesosphere/dcos/services/confluent-zookeeper/2.8.0-5.5.1/security">Confluent ZooKeeper 2.8.0-5.5.1</a></li><li><a href="/dcosdocs/mesosphere/dcos/services/confluent-zookeeper/2.7.0-5.1.2e/security">Confluent ZooKeeper 2.7.0-5.1.2e</a></li><li><a href="/dcosdocs/mesosphere/dcos/services/confluent-zookeeper/2.5.0-4.1.3e/security">Confluent ZooKeeper 2.5.0-4.1.3e</a></li></ul><div class="toggle"><p><span class="title">Confluent Zookeeper</span><span class="version"> 2.7.0-5.1.2e</span></p><i data-feather="chevron-down"></i></div></div></header><nav class="sidebar_nav" role="navigation"><ul><li><a class="d0" href="/dcosdocs/mesosphere/dcos/services/confluent-zookeeper/2.7.0-5.1.2e/release-notes/">Release Notes</a></li><li><a class="d0" href="/dcosdocs/mesosphere/dcos/services/confluent-zookeeper/2.7.0-5.1.2e/getting-started/">Getting Started</a></li><li><a class="d0" href="/dcosdocs/mesosphere/dcos/services/confluent-zookeeper/2.7.0-5.1.2e/advanced/">Advanced</a></li><li><a class="d0" href="/dcosdocs/mesosphere/dcos/services/confluent-zookeeper/2.7.0-5.1.2e/configuration/">Configuration</a></li><li><a class="d0" href="/dcosdocs/mesosphere/dcos/services/confluent-zookeeper/2.7.0-5.1.2e/operations/">Operations</a></li><li><a class="d0" href="/dcosdocs/mesosphere/dcos/services/confluent-zookeeper/2.7.0-5.1.2e/updates/">Updates</a></li><li class="active active-on"><a class="d0" href="/dcosdocs/mesosphere/dcos/services/confluent-zookeeper/2.7.0-5.1.2e/security/">Security</a></li><li><a class="d0" href="/dcosdocs/mesosphere/dcos/services/confluent-zookeeper/2.7.0-5.1.2e/uninstall/">Uninstall</a></li><li><a class="d0" href="/dcosdocs/mesosphere/dcos/services/confluent-zookeeper/2.7.0-5.1.2e/troubleshooting/">Troubleshooting</a></li><li><a class="d0" href="/dcosdocs/mesosphere/dcos/services/confluent-zookeeper/2.7.0-5.1.2e/api-reference/">API Reference</a></li><li><a class="d0" href="/dcosdocs/mesosphere/dcos/services/confluent-zookeeper/2.7.0-5.1.2e/limitations/">Limitations</a></li><li><a class="d0" href="/dcosdocs/mesosphere/dcos/services/confluent-zookeeper/2.7.0-5.1.2e/support-policy/">Support Policy</a></li></ul></nav><footer class="sidebar__footer"><div class="sidebar__footer-links"><a href="https://d2iq.com/terms/">Terms of Service</a><a href="https://d2iq.com/privacy/">Privacy Policy</a></div><a class="sidebar__footer-copyright" href="https://d2iq.com/">&copy; 2021 D2iQ, Inc. All rights reserved.</a></footer></section></div><div class="layout__content" role="main"><main class="content"><div class="content__container content__container--with-sections"><div class="content__header"><div class="content__header__row"><h1 class="content__header-title">Security</h1></div><div class="actions"><ul class="actions__list"><li class="actions__item"><button class="actions__link" onclick="javascript:window.print()"><i class="actions__icon" data-feather="printer"></i><span class="actions__text">Print</span></button></li><li class="actions__item"><a class="actions__link" href="https://github.com/mesosphere/dcos-docs-site/tree/main/pages/dcosdocs/mesosphere/dcos/services/confluent-zookeeper/2.7.0-5.1.2e/security/index.md" target="_blank"><i class="actions__icon" data-feather="github"></i><span class="actions__text">Contribute</span></a></li><li class="actions__item"><a class="actions__link" href="https://jira.d2iq.com/secure/CreateIssueDetails!init.jspa?pid=14105&amp;issuetype=1&amp;summary=Feedback+for+Security&amp;description=Source:%20https://docs.d2iq.com/dcosdocs/mesosphere/dcos/services/confluent-zookeeper/2.7.0-5.1.2e/security&amp;labels=documentation&amp;labels=needs_triage&amp;components=19804&amp;priority=3&amp;customfield_12300=44" target="_blank"><i class="actions__icon" data-feather="message-square"></i><span class="actions__text">Feedback</span></a></li></ul></div></div><article class="content__article"><h1 id="dcos-confluent-zookeeper-security"><a class="content__anchor" href="#dcos-confluent-zookeeper-security" aria-hidden="true"><i data-feather="bookmark"></i></a>DC/OS Confluent ZooKeeper Security</h1>
<ul>
<li>
<p>The DC/OS Confluent ZooKeeper service allows you to create a service account to configure access for Confluent ZooKeeper. The service allows you to create and assign permissions as required for access.</p>
</li>
<li>
<p>The DC/OS Confluent ZooKeeper service supports ZooKeeper’s native Kerberos authentication mechanism. The service provides automation and orchestration to simplify the usage of these important features, with both <a href="https://cwiki.apache.org/confluence/display/ZOOKEEPER/Client-Server+mutual+authentication">Client-Server</a> and <a href="https://cwiki.apache.org/confluence/display/ZOOKEEPER/Server-Server+mutual+authentication">Server-Server</a> mutual authentication supported.</p>
</li>
</ul>
<p>An overview of the ZooKeeper Kerberos security features can be found <a href="https://cwiki.apache.org/confluence/display/ZOOKEEPER/ZooKeeper+and+SASL">here</a>.</p>
<p class="message--note"><strong>NOTE: </strong> These security features are only available on DC/OS Enterprise 1.10 and later.</p>
<h1 id="provisioning-a-service-account"><a class="content__anchor" href="#provisioning-a-service-account" aria-hidden="true"><i data-feather="bookmark"></i></a><a name="provision-a-service-account"></a>Provisioning a service account</h1>
<p>This section describes how to configure DC/OS access for Confluent ZooKeeper. Depending on your <a href="/dcosdocs/mesosphere/dcos/latest/security/ent/#security-modes/">security mode</a>, Confluent ZooKeeper may require <a href="/dcosdocs/mesosphere/dcos/latest/security/ent/service-auth/">service authentication</a> for access to DC/OS.</p>
<p>A service like Confluent ZooKeeper typically performs certain privileged actions on the cluster, which might require authenticating with the cluster. A service account associated with the service is used to authenticate with the DC/OS cluster. It is recommended to provisioning a separate service account for each service that would perform privileged operations. Service accounts authenticate using public-private keypair. The public key is used to create the service account in the cluster, while the corresponding private key is stored in the <a href="/dcosdocs/mesosphere/dcos/latest/security/ent/secrets/">secret store</a>. The service account and the service account secret are passed to the service as install time options.</p>
<table>
<thead>
<tr>
<th>Security mode</th>
<th>Service Account</th>
</tr>
</thead>
<tbody>
<tr>
<td>Disabled</td>
<td>Not available</td>
</tr>
<tr>
<td>Permissive</td>
<td>Optional</td>
</tr>
<tr>
<td>Strict</td>
<td>Required</td>
</tr>
</tbody>
</table>
<p>If you install a service in permissive mode and do not specify a service account, Metronome and Marathon will act as if requests made by this service are made by an account with the <a href="/dcosdocs/mesosphere/dcos/latest/security/ent/perms-reference/#superuser">superuser permission</a>.</p>
<h2 id="prerequisites"><a class="content__anchor" href="#prerequisites" aria-hidden="true"><i data-feather="bookmark"></i></a>Prerequisites:</h2>
<ul>
<li><a href="/dcosdocs/mesosphere/dcos/latest/cli/install/">DC/OS CLI installed</a> and be logged in as a superuser.</li>
<li><a href="/dcosdocs/mesosphere/dcos/latest/cli/enterprise-cli/#ent-cli-install">Enterprise DC/OS CLI 0.4.14 or later installed</a>.</li>
</ul>
<h1 id="create-a-key-pair"><a class="content__anchor" href="#create-a-key-pair" aria-hidden="true"><i data-feather="bookmark"></i></a><a name="create-a-keypair"></a>Create a Key Pair</h1>
<p>In this step, a 2048-bit RSA public-private key pair is created using the Enterprise DC/OS CLI.</p>
<p>Create a public-private key pair and save each value into a separate file within the current directory.</p>
<pre><code class="language-bash">dcos security org service-accounts keypair &lt;private-key&gt;.pem &lt;public-key&gt;.pem
</code></pre>
<p class="message--note"><strong>NOTE: </strong>You can use the <a href="https://docs.d2iq.com/dcosdocs/mesosphere/dcos/latest/security/ent/secrets/">DC/OS Secret Store</a> to secure the key pair.</p>
<h1 id="create-a-service-account"><a class="content__anchor" href="#create-a-service-account" aria-hidden="true"><i data-feather="bookmark"></i></a><a name="create-a-service-account"></a>Create a Service Account</h1>
<p>From a terminal prompt, create a new service account (for example, <code>confluent-zookeeper</code>) containing the public key (<code>&lt;your-public-key&gt;.pem</code>).</p>
<pre><code class="language-bash">dcos security org service-accounts create -p &lt;your-public-key&gt;.pem -d &lt;description&gt; confluent-zookeeper
</code></pre>
<p>You can verify your new service account using the following command.</p>
<pre><code class="language-bash">dcos security org service-accounts show confluent-zookeeper
</code></pre>
<h1 id="create-a-secret"><a class="content__anchor" href="#create-a-secret" aria-hidden="true"><i data-feather="bookmark"></i></a><a name="create-an-sa-secret"></a>Create a Secret</h1>
<p>Create a secret (<code>confluent-zookeeper/&lt;secret-name&gt;</code>) with your service account and private key specified (<code>&lt;private-key&gt;.pem</code>).</p>
<p class="message--note"><strong>NOTE: </strong>If you store your secret in a path that matches the service name, for example, service name and secret path are both confluent-zookeeper, then only the service named confluent-zookeeper can access it.</p>
<pre><code class="language-bash">dcos security secrets create-sa-secret &lt;private-key&gt;.pem &lt;service-account-id&gt; confluent-zookeeper/&lt;secret-name&gt;
</code></pre>
<p class="message--note"><strong>NOTE: </strong>If you are running, now EOL-ed, DC/OS 1.11 or older you would need to add <tt>--strict</tt> to the above command. For example, <tt>dcos security secrets --strict create-sa-secret <private-key>.pem <service-account-id> confluent-zookeeper/sa-secret</tt> .</p>
<p>You can list the secrets with this command:</p>
<pre><code class="language-bash">dcos security secrets list /
</code></pre>
<h1 id="create-and-assign-permissions"><a class="content__anchor" href="#create-and-assign-permissions" aria-hidden="true"><i data-feather="bookmark"></i></a><a name="give-perms"></a>Create and Assign Permissions</h1>
<p>Use the following DC/OS CLI commands to rapidly provision the Confluent ZooKeeper service account with the required permissions.</p>
<ol>
<li>Create the permission.</li>
</ol>
<p class="message--important"><strong>IMPORTANT: </strong>The value to be used for <tt>&lt;service-role&gt;</tt> will be based on the service name, package version and DC/OS version. The table below shows a few examples of service names and the corresponding Mesos roles they would use. This version of confluent-zookeeper is quota support built in. To determine whether the service group, you are deploying a service to, has <tt>enforceRole</tt> set to <tt>true</tt> or <tt>false</tt> please check this <a href="https://support.d2iq.com/s/article/How-to-determine-if-a-top-level-group-is-quota-limited">KB article</a>. </p>
<p>If you need help configuring the permissions for confluent-zookeeper, please feel to reach out to D2iQ support by filing a support ticket. Replace the instances of <tt>&lt;service-role&gt;</tt> with the correct name (<tt>&lt;name&gt;-role</tt>).</p>
<table>
<thead>
<tr>
<th><strong>Service name</strong></th>
<th><strong>&lt;service-role&gt;</strong><br>DC/OS 1.13 or older<br>DC/OS 2.0 or newer AND enforceRole=false</th>
<th><strong>&lt;service-role&gt;</strong><br>DC/OS 2.0 or newer AND enforceRole=true</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>/confluent-zookeeper</code></td>
<td><code>confluent-zookeeper-role</code></td>
<td><code>confluent-zookeeper-role</code></td>
</tr>
<tr>
<td><code>/confluent-zookeeper-prod</code></td>
<td><code>confluent-zookeeper-prod-role</code></td>
<td><code>confluent-zookeeper-prod-role</code></td>
</tr>
<tr>
<td><code>/team01/confluent-zookeeper</code></td>
<td><code>team01__confluent-zookeeper-role</code></td>
<td><code>team01</code></td>
</tr>
<tr>
<td><code>/team01/prod/confluent-zookeeper</code></td>
<td><code>team01__prod__confluent-zookeeper-role</code></td>
<td><code>team01</code></td>
</tr>
</tbody>
</table>
<h2 id="permissive"><a class="content__anchor" href="#permissive" aria-hidden="true"><i data-feather="bookmark"></i></a>Permissive</h2>
<p>Run these commands with the service account name you created for the service in the <em>Create a Service Account</em> step above. For example we are using confluent-zookeeper</p>
<pre><code class="language-bash">dcos security org users grant confluent-zookeeper dcos:mesos:master:framework:role:&lt;service-role&gt; create --description &quot;Allow registering as a framework of role &lt;service-role&gt; with Mesos master&quot;
dcos security org users grant confluent-zookeeper dcos:mesos:master:reservation:role:&lt;service-role&gt; create --description &quot;Allow creating Mesos resource reservations of role &lt;service-role&gt;&quot;
dcos security org users grant confluent-zookeeper dcos:mesos:master:volume:role:&lt;service-role&gt; create --description &quot;Allow creating Mesos persistent volumes of role &lt;service-role&gt;&quot;
dcos security org users grant confluent-zookeeper dcos:mesos:master:reservation:principal:confluent-zookeeper delete --description &quot;Allow unreserving Mesos resource reservations with principal confluent-zookeeper&quot;
dcos security org users grant confluent-zookeeper dcos:mesos:master:volume:principal:confluent-zookeeper delete --description &quot;Allow deleting Mesos persistent volumes with principal confluent-zookeeper&quot;
</code></pre>
<h2 id="strict"><a class="content__anchor" href="#strict" aria-hidden="true"><i data-feather="bookmark"></i></a>Strict</h2>
<p>Run these commands with the service account name you created for the service in the <em>Create a Service Account</em> step above. For example we are using confluent-zookeeper</p>
<pre><code class="language-bash">dcos security org users grant confluent-zookeeper dcos:mesos:master:task:user:nobody create --description &quot;Allow running a task as linux user nobody&quot;
dcos security org users grant confluent-zookeeper dcos:mesos:master:framework:role:&lt;service-role&gt; create --description &quot;Allow registering as a framework of role &lt;service-role&gt; with Mesos master&quot;
dcos security org users grant confluent-zookeeper dcos:mesos:master:reservation:role:&lt;service-role&gt; create --description &quot;Allow creating Mesos resource reservations of role &lt;service-role&gt;&quot;
dcos security org users grant confluent-zookeeper dcos:mesos:master:volume:role:&lt;service-role&gt; create --description &quot;Allow creating Mesos persistent volumes of role &lt;service-role&gt;&quot;
dcos security org users grant confluent-zookeeper dcos:mesos:master:reservation:principal:confluent-zookeeper delete --description &quot;Allow unreserving Mesos resource reservations with principal confluent-zookeeper&quot;
dcos security org users grant confluent-zookeeper dcos:mesos:master:volume:principal:confluent-zookeeper delete --description &quot;Allow deleting Mesos persistent volumes with principal confluent-zookeeper&quot;
</code></pre>
<h2 id="authentication"><a class="content__anchor" href="#authentication" aria-hidden="true"><i data-feather="bookmark"></i></a>Authentication</h2>
<p>DC/OS Confluent ZooKeeper supports the Kerberos authentication mechanism.</p>
<h3 id="kerberos-authentication"><a class="content__anchor" href="#kerberos-authentication" aria-hidden="true"><i data-feather="bookmark"></i></a>Kerberos Authentication</h3>
<p>Kerberos authentication relies on a central authority to verify that ZooKeeper clients are who they say they are. DC/OS Confluent ZooKeeper integrates with your existing Kerberos infrastructure to verify the identity of clients.</p>
<h4 id="prerequisites-2"><a class="content__anchor" href="#prerequisites-2" aria-hidden="true"><i data-feather="bookmark"></i></a>Prerequisites</h4>
<ul>
<li>The hostname and port of a KDC reachable from your DC/OS cluster</li>
<li>Sufficient access to the KDC to create Kerberos principals</li>
<li>Sufficient access to the KDC to retrieve a keytab for the generated principals</li>
<li><a href="/dcosdocs/mesosphere/dcos/latest/cli/enterprise-cli/#installing-the-dcos-enterprise-cli">The DC/OS Enterprise CLI</a></li>
<li>DC/OS Superuser permissions</li>
</ul>
<h4 id="configure-kerberos-authentication"><a class="content__anchor" href="#configure-kerberos-authentication" aria-hidden="true"><i data-feather="bookmark"></i></a>Configure Kerberos Authentication</h4>
<h4 id="create-principals"><a class="content__anchor" href="#create-principals" aria-hidden="true"><i data-feather="bookmark"></i></a>Create principals</h4>
<p>The DC/OS Confluent ZooKeeper service requires a Kerberos principal for each server to be deployed. Each principal must be of the form</p>
<pre><code>&lt;service primary&gt;/zookeeper-&lt;server index&gt;-server.&lt;service subdomain&gt;.autoip.dcos.thisdcos.directory@&lt;service realm&gt;
</code></pre>
<p>with:</p>
<ul>
<li><code>service primary = service.security.kerberos.primary</code></li>
<li><code>server index = 0 up to node.count - 1</code></li>
<li><code>service subdomain = service.name with all</code>/<code>'s removed</code></li>
<li><code>service realm = service.security.kerberos.realm</code></li>
</ul>
<p>For example, if installing with these options in addition to your own:</p>
<pre><code class="language-json">{
    &quot;service&quot;: {
        &quot;name&quot;: &quot;a/good/example&quot;,
        &quot;security&quot;: {
            &quot;kerberos&quot;: {
                &quot;primary&quot;: &quot;example&quot;,
                &quot;realm&quot;: &quot;EXAMPLE&quot;
            }
        }
    },
    &quot;node&quot;: {
        &quot;count&quot;: 3
    }
}
</code></pre>
<p>then the principals to create would be:</p>
<pre><code>example/zookeeper-0-server.agoodexample.autoip.dcos.thisdcos.directory@EXAMPLE
example/zookeeper-1-server.agoodexample.autoip.dcos.thisdcos.directory@EXAMPLE
example/zookeeper-2-server.agoodexample.autoip.dcos.thisdcos.directory@EXAMPLE
</code></pre>
<h5 id="active-directory"><a class="content__anchor" href="#active-directory" aria-hidden="true"><i data-feather="bookmark"></i></a>Active Directory</h5>
<p>Microsoft Active Directory can be used as a Kerberos KDC. Doing so requires creating a mapping between Active Directory users and Kerberos principals.</p>
<p>The utility <a href="https://docs.microsoft.com/en-us/windows-server/administration/windows-commands/ktpass">ktpass</a> can be used to both create a keytab from Active Directory and generate the mapping at the same time.</p>
<p>The mapping <em>can</em>, however, be created manually. For a Kerberos principal like <code>&lt;primary&gt;/&lt;host&gt;@&lt;REALM&gt;</code>, the Active Directory user should have its <code>servicePrincipalName</code> and <code>userPrincipalName</code> attributes set to,</p>
<pre><code>servicePrincipalName = &lt;primary&gt;/&lt;host&gt;
userPrincipalName = &lt;primary&gt;/&lt;host&gt;@&lt;REALM&gt;
</code></pre>
<p>For example, with the Kerberos principal <code>example&amp;#x2F;zookeeper-0-server.agoodexample.autoip.dcos.thisdcos.directory@EXAMPLE</code>, then the correct mapping would be,</p>
<pre><code>servicePrincipalName = example&amp;#x2F;zookeeper-0-server.agoodexample.autoip.dcos.thisdcos.directory
userPrincipalName = example&amp;#x2F;zookeeper-0-server.agoodexample.autoip.dcos.thisdcos.directory@EXAMPLE
</code></pre>
<p>If either mapping is incorrect or not present, the service will fail to authenticate that Principal. The symptom in the Kerberos debug logs will be an error of the form</p>
<pre><code>KRBError:
sTime is Wed Feb 07 03:22:47 UTC 2018 1517973767000
suSec is 697984
error code is 6
error Message is Client not found in Kerberos database
sname is krbtgt/AD.MESOSPHERE.COM@AD.MESOSPHERE.COM
msgType is 30
</code></pre>
<p>when the <code>userPrincipalName</code> is set incorrectly, and an error of the form</p>
<pre><code>KRBError:
sTime is Wed Feb 07 03:44:57 UTC 2018 1517975097000
suSec is 128465
error code is 7
error Message is Server not found in Kerberos database
sname is kafka/kafka-1-broker.confluent-kafka.autoip.dcos.thisdcos.directory@AD.MESOSPHERE.COM
msgType is 30
</code></pre>
<p>when the <code>servicePrincipalName</code> is set incorrectly.</p>
<h4 id="place-service-keytab-in-dcos-secret-store"><a class="content__anchor" href="#place-service-keytab-in-dcos-secret-store" aria-hidden="true"><i data-feather="bookmark"></i></a>Place Service Keytab in DC/OS Secret Store</h4>
<p>The DC/OS Confluent ZooKeeper service uses a keytab containing all node principals (service keytab). After creating the principals above, generate the service keytab making sure to include all the node principals. This will be stored as a secret in the DC/OS Secret Store.</p>
<p class="message--note"><strong>NOTE: </strong>DC/OS 1.10 does not support adding binary secrets directly to the secret store, only text files are supported. Instead, first base64 encode the file, and save it to the secret store as <tt>/desired/path/__dcos_base64__secret_name</tt>. The DC/OS security modules will handle decoding the file when it is used by the service. </p>
<p>The service keytab should be stored at <code>service/path/name/service.keytab</code>. As noted above. for DC/OS 1.10, it would be <code>__dcos_base64__service.keytab</code>), where <code>service/path/name</code> matches the path and name of the service. For example, if installing with the options</p>
<pre><code class="language-json">{
    &quot;service&quot;: {
        &quot;name&quot;: &quot;a/good/example&quot;
    }
}
</code></pre>
<p>then the service keytab should be stored at <code>a/good/example/service.keytab</code>.</p>
<p>Documentation for adding a file to the secret store can be found <a href="/dcosdocs/mesosphere/dcos/latest/security/ent/secrets/create-secrets/#creating-secrets-from-a-file-via-the-dcos-enterprise-cli">here</a>.</p>
<p class="message--note"><strong>NOTE: </strong>Secrets access is controlled by <a href="/dcosdocs/mesosphere/dcos/latest/security/ent/#spaces-for-secrets">DC/OS Spaces</a>, which function like namespaces. Any secret in the same DC/OS Space as the service will be accessible by the service. However, matching the two paths is the most secure option. Additionally the secret name <tt>service.keytab</tt> is a convention and not a requirement.</p>
<h4 id="install-the-service"><a class="content__anchor" href="#install-the-service" aria-hidden="true"><i data-feather="bookmark"></i></a>Install the Service</h4>
<p>Install the DC/OS Confluent ZooKeeper service with the following options in addition to your own:</p>
<pre><code class="language-json">{
    &quot;service&quot;: {
        &quot;security&quot;: {
            &quot;kerberos&quot;: {
                &quot;enabled&quot;: true,
                &quot;kdc&quot;: {
                    &quot;hostname&quot;: &quot;&lt;kdc host&gt;&quot;,
                    &quot;port&quot;: &lt;kdc port&gt;
                },
                &quot;primary&quot;: &quot;&lt;service primary default zookeeper&gt;&quot;,
                &quot;realm&quot;: &quot;&lt;realm&gt;&quot;,
                &quot;keytab_secret&quot;: &quot;&lt;path to keytab secret&gt;&quot;,
                &quot;debug&quot;: &lt;true|false default false&gt;
            }
        }
    }
}
</code></pre>
<p class="message--note"><strong>NOTE: </strong> It is possible to enable Kerberos after initial installation but the service may be unavailable during the transition. Additionally, your ZooKeeper clients will need to be reconfigured. For more information see the following section.</p>
<h4 id="enabling-kerberos-after-deployment"><a class="content__anchor" href="#enabling-kerberos-after-deployment" aria-hidden="true"><i data-feather="bookmark"></i></a>Enabling Kerberos After Deployment</h4>
<p>It is possible to enable Kerberos authentication after the deployment of DC/OS Confluent ZooKeeper. As described in the (Rolling Upgrade)[https://cwiki.apache.org/confluence/display/ZOOKEEPER/Server-Server+mutual+authentication] section of the Apache ZooKeeper documentation, this requires multiple rolling restarts of the ZooKeeper ensemble and client connectivity may be lost at times.</p>
<p>Assuming that DC/OS Confluent ZooKeeper was initially deployed with <code>service.security.kerberos.enabled</code> set to <code>false</code>, the following steps can be used to enable Kerberos for the service.</p>
<p>Firstly – assuming the same Kerberos settings as discussed in <a href="#configure-kerberos-authentication">Configure Kerberos Authentication</a> – create the keytab for the Kerberos principals and add this keytab to the DC/OS Secret Store as described in the <a href="#create-principals">Create principals</a> and <a href="#place-service-keytab-in-dc-os-secret-store">Place Service Keytab in DC/OS Secret Store</a> sections. Then create a <code>kerberos-toggle-step-1.json</code> file with the following contents:</p>
<pre><code class="language-json">{
    &quot;service&quot;: {
        &quot;security&quot;: {
            &quot;kerberos&quot;: {
                &quot;enabled&quot;: true,
                &quot;kdc&quot;: {
                    &quot;hostname&quot;: &quot;&lt;kdc host&gt;&quot;,
                    &quot;port&quot;: &lt;kdc port&gt;
                },
                &quot;primary&quot;: &quot;&lt;service primary default zookeeper&gt;&quot;,
                &quot;realm&quot;: &quot;&lt;realm&gt;&quot;,
                &quot;keytab_secret&quot;: &quot;&lt;path to keytab secret&gt;&quot;,
                &quot;debug&quot;: &lt;true|false default false&gt;,
                &quot;advanced&quot;: {
                    &quot;required_for_quorum_learner&quot;: false,
                    &quot;required_for_quorum_server&quot;: false,
                    &quot;required_for_client&quot;: false
                }
            }
        }
    }
}
</code></pre>
<p>where it is important to note the <code>service.security.kerberos.advanced</code> section that is present here.</p>
<p>Using this config file, update your DC/OS Confluent ZooKeeper service:</p>
<pre><code class="language-bash">$ dcos confluent-zookeeper --name=&lt;service name&gt; update start --options=kerberos-toggle-step-1.json
</code></pre>
<p>and wait for the deploy (update) plan to complete:</p>
<pre><code class="language-bash">$ dcos confluent-zookeeper --name=&lt;service name&gt; plan show deploy
deploy (serial strategy) (COMPLETE)
└─ node-update (serial strategy) (COMPLETE)
   ├─ zookeeper-0:[server, metrics] (COMPLETE)
   ├─ zookeeper-1:[server, metrics] (COMPLETE)
   └─ zookeeper-2:[server, metrics] (COMPLETE)
</code></pre>
<p>The service will now have deployed with Kerberos enabled, but with non-authenticated connections for leader election and from clients still allowed. In order to obtain a secure cluster, these unauthenticated connections should now be turned off to force secure connections.</p>
<p>Create a <code>kerberos-toggle-step-2.json</code> file with the following contents (note that it is only required to specify the options that change):</p>
<pre><code class="language-json">{
    &quot;service&quot;: {
        &quot;security&quot;: {
            &quot;kerberos&quot;: {
                &quot;advanced&quot;: {
                    &quot;required_for_quorum_learner&quot;: true,
                    &quot;required_for_quorum_server&quot;: false,
                    &quot;required_for_client&quot;: false
                }
            }
        }
    }
}
</code></pre>
<p>and deploy this as a configuration update:</p>
<pre><code class="language-bash">$ dcos confluent-zookeeper --name=&lt;service name&gt; update start --options=kerberos-toggle-step-2.json
$ dcos confluent-zookeeper --name=&lt;service name&gt; plan show deploy
deploy (serial strategy) (COMPLETE)
└─ node-update (serial strategy) (COMPLETE)
   ├─ zookeeper-0:[server, metrics] (COMPLETE)
   ├─ zookeeper-1:[server, metrics] (COMPLETE)
   └─ zookeeper-2:[server, metrics] (COMPLETE)
</code></pre>
<p>deploying a Confluent ZooKeeper instance that <em>requires</em> Kerberos authentication between learners in the leader election.</p>
<p>As the next step in the rolling update process, create a <code>kerberos-toggle-step-3.json</code> file with the following contents:</p>
<pre><code class="language-json">{
    &quot;service&quot;: {
        &quot;security&quot;: {
            &quot;kerberos&quot;: {
                &quot;advanced&quot;: {
                    &quot;required_for_quorum_learner&quot;: true,
                    &quot;required_for_quorum_server&quot;: true,
                    &quot;required_for_client&quot;: false
                }
            }
        }
    }
}
</code></pre>
<p>and deploy this as a configuration update:</p>
<pre><code class="language-bash">$ dcos confluent-zookeeper --name=&lt;service name&gt; update start --options=kerberos-toggle-step-3.json
$ dcos confluent-zookeeper --name=&lt;service name&gt; plan show deploy
deploy (serial strategy) (COMPLETE)
└─ node-update (serial strategy) (COMPLETE)
   ├─ zookeeper-0:[server, metrics] (COMPLETE)
   ├─ zookeeper-1:[server, metrics] (COMPLETE)
   └─ zookeeper-2:[server, metrics] (COMPLETE)
</code></pre>
<p>Confluent ZooKeeper will now require Kerberos authentication for the entire leader election process.</p>
<p>The final step is to require Kerberos authentication for clients connecting to the DC/OS Confluent ZooKeeper instance with an options file (say <code>kerberos-toggle-step-4.json</code>) as follows:</p>
<pre><code class="language-json">{
    &quot;service&quot;: {
        &quot;security&quot;: {
            &quot;kerberos&quot;: {
                &quot;advanced&quot;: {
                    &quot;required_for_quorum_learner&quot;: true,
                    &quot;required_for_quorum_server&quot;: true,
                    &quot;required_for_client&quot;: true
                }
            }
        }
    }
}
</code></pre>
<p>which is deployed:</p>
<pre><code class="language-bash">$ dcos confluent-zookeeper --name=&lt;service name&gt; update start --options=kerberos-toggle-step-3.json
$ dcos confluent-zookeeper --name=&lt;service name&gt; plan show deploy
deploy (serial strategy) (COMPLETE)
└─ node-update (serial strategy) (COMPLETE)
   ├─ zookeeper-0:[server, metrics] (COMPLETE)
   ├─ zookeeper-1:[server, metrics] (COMPLETE)
   └─ zookeeper-2:[server, metrics] (COMPLETE)
</code></pre>
<p>Unauthenticated clients will now only be allowed to ping, create a session, close a session, or authenticate when communicating with the Confluent ZooKeeper instance.</p>
<p class="message--note"><strong>NOTE: </strong> The default settings for <code>service.security.kerberos.advanced.required_for_quorum_learner</code>, <code>service.security.kerberos.advanced.required_for_quorum_server</code>, <code>service.security.kerberos.advanced.required_for_client</code> are all <code>true</code>.</p>
<h4 id="disabling-kerberos-after-deployment"><a class="content__anchor" href="#disabling-kerberos-after-deployment" aria-hidden="true"><i data-feather="bookmark"></i></a>Disabling Kerberos After Deployment</h4>
<p class="message--note"><strong>NOTE: </strong> Disabling Kerberos after deployment is <strong>not</strong> supported.</p>
<h2 id="securely-exposing-dcos-confluent-zookeeper-outside-the-cluster"><a class="content__anchor" href="#securely-exposing-dcos-confluent-zookeeper-outside-the-cluster" aria-hidden="true"><i data-feather="bookmark"></i></a>Securely Exposing DC/OS Confluent ZooKeeper Outside the Cluster.</h2>
<p>Kerberos security is tightly coupled to the DNS hosts of the zookeeper tasks. As such, exposing a secure Confluent ZooKeeper service outside of the cluster requires additional setup.</p>
<h3 id="server-to-client-connection"><a class="content__anchor" href="#server-to-client-connection" aria-hidden="true"><i data-feather="bookmark"></i></a>Server to Client Connection</h3>
<p>To expose a secure Confluent ZooKeeper service outside of the cluster, any client connecting to it must be able to access all tasks of the service via the IP address assigned to the task. This IP address will be one of: an IP address on a virtual network or the IP address of the agent the task is running on.</p>
<h3 id="forwarding-dns-and-custom-domain"><a class="content__anchor" href="#forwarding-dns-and-custom-domain" aria-hidden="true"><i data-feather="bookmark"></i></a>Forwarding DNS and Custom Domain</h3>
<p>Every DC/OS cluster has a unique cryptographic ID which can be used to forward DNS queries to that Cluster. To securely expose the service outside the cluster, external clients must have an upstream resolver configured to forward DNS queries to the DC/OS cluster of the service as described <a href="/dcosdocs/mesosphere/dcos/latest/networking/DNS/mesos-dns/expose-mesos-zone/">here</a>.</p>
<p>With only forwarding configured, DNS entries within the DC/OS cluster will be resolvable at <code>&lt;task-domain&gt;.autoip.dcos.&lt;cryptographic-id&gt;.dcos.directory</code>. However, if you configure a DNS alias, you can use a custom domain. For example, <code>&lt;task-domain&gt;.cluster-1.acmeco.net</code>. In either case, the DC/OS Confluent ZooKeeper service will need to be installed with an additional security option:</p>
<pre><code class="language-json">{
    &quot;service&quot;: {
        &quot;security&quot;: {
            &quot;custom_domain&quot;: &quot;&lt;custom-domain&gt;&quot;
        }
    }
}
</code></pre>
<p>where <code>&lt;custom-domain&gt;</code> is one of <code>autoip.dcos.&lt;cryptographic-id&gt;.dcos.directory</code> or your organization specific domain (e.g., <code>cluster-1.acmeco.net</code>).</p>
<p>As a concrete example, using the custom domain of <code>cluster-1.acmeco.net</code> the server 0 task would have a host of <code>zookeeper-0-server.&lt;service-name&gt;.cluster-1.acmeco.net</code>.</p>
<h3 id="kerberos-principal-changes"><a class="content__anchor" href="#kerberos-principal-changes" aria-hidden="true"><i data-feather="bookmark"></i></a>Kerberos Principal Changes</h3>
<p>With a custom domain endpoint discovery will work as normal. Kerberos, however, does require slightly different configuration. As noted in the section <a href="#create-principals">Create Principals</a>, the principals of the service depend on the hostname of the service. When creating the Kerberos principals, be sure to use the correct domain.</p>
<p>For example, if installing with these settings:</p>
<pre><code class="language-json">{
    &quot;service&quot;: {
        &quot;name&quot;: &quot;a/good/example&quot;,
        &quot;security&quot;: {
            &quot;kerberos&quot;: {
                &quot;primary&quot;: &quot;example&quot;,
                &quot;realm&quot;: &quot;EXAMPLE&quot;
            }
        }
    },
    &quot;node&quot;: {
        &quot;count&quot;: 3
    }
}
</code></pre>
<p>then the principals to create would be:</p>
<pre><code>example/zookeeper-0-server.agoodexample.cluster-1.example.net@EXAMPLE
example/zookeeper-1-server.agoodexample.cluster-1.example.net@EXAMPLE
example/zookeeper-2-server.agoodexample.cluster-1.example.net@EXAMPLE
</code></pre>
</article></div><aside class="content__sections"><div class="content__sections-list-container"><ul class="content__sections-list"><li class="content__sections-item content__sections-item--h1"><a href="#dcos-confluent-zookeeper-security">DC/OS Confluent ZooKeeper Security</a></li><li class="content__sections-item content__sections-item--h1"><a href="#provisioning-a-service-account">Provisioning a service account</a></li><li class="content__sections-item content__sections-item--h2"><a href="#prerequisites">Prerequisites:</a></li><li class="content__sections-item content__sections-item--h1"><a href="#create-a-key-pair">Create a Key Pair</a></li><li class="content__sections-item content__sections-item--h1"><a href="#create-a-service-account">Create a Service Account</a></li><li class="content__sections-item content__sections-item--h1"><a href="#create-a-secret">Create a Secret</a></li><li class="content__sections-item content__sections-item--h1"><a href="#create-and-assign-permissions">Create and Assign Permissions</a></li><li class="content__sections-item content__sections-item--h2"><a href="#permissive">Permissive</a></li><li class="content__sections-item content__sections-item--h2"><a href="#strict">Strict</a></li><li class="content__sections-item content__sections-item--h2"><a href="#authentication">Authentication</a></li><li class="content__sections-item content__sections-item--h2"><a href="#securely-exposing-dcos-confluent-zookeeper-outside-the-cluster">Securely Exposing DC/OS Confluent ZooKeeper Outside the Cluster.</a></li></ul></div></aside></main></div></div><script src="/assets/js/jquery-3.2.1.js"></script><script src="/assets/js/clipboard.js"></script><script src="/assets/js/prism.js"></script><script src="/js/main.js"></script></body></html>