<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width" initial-scale="1" user-scalable="no"><title>Multi-Region DC/OS on Azure using the Universal Installer - D2iQ Docs</title><meta name="description" content="Guide for DC/OS on Azure using the Universal Installer adding a remote region."><link rel="apple-touch-icon" sizes="180x180" href="/assets/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/favicon-16x16.png"><link rel="stylesheet" type="text/css" href="/css/styles.css"><link rel="search" type="application/opensearchdescription+xml" href="/assets/opensearch.xml" title="Search"><link href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,500,500i,700,700i" rel="stylesheet"><script src="https://unpkg.com/feather-icons/dist/feather.min.js"></script><script>window.analytics||(window.analytics=[]),window.analytics.methods=["identify","track","trackLink","trackForm","trackClick","trackSubmit","page","pageview","ab","alias","ready","group","on","once","off"],window.analytics.factory=function(t){return function(){var a=Array.prototype.slice.call(arguments);return a.unshift(t),window.analytics.push(a),window.analytics}};for(var i=0;i<window.analytics.methods.length;i++){var method=window.analytics.methods[i];window.analytics[method]=window.analytics.factory(method)}window.analytics.load=function(t){var a=document.createElement("script");a.type="text/javascript",a.async=!0,a.src=("https:"===document.location.protocol?"https://":"http://")+"d2dq2ahtl5zl1z.cloudfront.net/analytics.js/v1/"+t+"/analytics.min.js";var n=document.getElementsByTagName("script")[0];n.parentNode.insertBefore(a,n)},window.analytics.SNIPPET_VERSION="2.0.8",
window.analytics.load("7sgtwqvuai");
window.analytics.page();</script><noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-PBJ84KX" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript><script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src='//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-PBJ84KX');</script></head><body><div class="layout"><header class="header"><a class="header__drawer"><i class="header__icon" data-feather="menu"></i></a><a class="header__logo" href="/"><img class="header__logo--mobile" src="/assets/D2iQ_Logotype_Color_Positive_Documentation.svg" alt="D2IQ"><img class="header__logo--desktop" src="/assets/D2iQ_Logotype_Color_Positive_Documentation.svg" alt="D2IQ"></a><div class="header__main"><div class="header__dropdown"><img class="header__dropdown-icon" src="/assets/D2IQ_Logotype_Color_Positive.png" alt="D2iQ"><strong>DC/OS Documentation</strong><i data-feather="chevron-down"></i></div><nav class="header__menu"><ul class="header__menu-list"><li class="header__menu-item"><a href="/mesosphere/dcos">DC/OS</a></li><li class="header__menu-item"><a href="/dcosdocs/mesosphere/dcos/services">Services</a></li><li class="header__menu-item"><a href="https://support.d2iq.com">Support</a></li></ul></nav></div><div class="chooser" id="spherer"><div class="chooser-current"><a class="chooser-title">Mesosphere</a><svg class="chooser-svg" id="spherer-svg"><path class="pointer" d="m 13,6 -5,5 -5,-5 z" fill="#858585"></path></svg></div><ul class="chooser-list" id="spherer-list"><li class="chooser-list-item"><a href="/mesosphere/dcos">DC/OS</a></li><li class="chooser-list-item"><a href="/dcosdocs/mesosphere/dcos/services">DC/OS Services</a></li></ul></div><div class="chooser" id="ks"><div class="chooser-current"><a class="chooser-title">DKP</a><svg class="chooser-svg" id="kspherer-svg"><path class="pointer" d="m 13,6 -5,5 -5,-5 z" fill="#858585"></path></svg></div><ul class="chooser-list" id="kspherer-list"><li class="chooser-list-item"><a href="/dkp/konvoy">Konvoy</a></li><li class="chooser-list-item"><a href="/dkp/konvoy/partner-solutions">Partner Solutions</a></li><li class="chooser-list-item"><a href="/dkp/kommander">Kommander</a></li><li class="chooser-list-item"><a href="/dkp/dispatch">Dispatch</a></li><li class="chooser-list-item"><a href="/dkp/kaptain">Kaptain</a></li><li class="chooser-list-item"><a href="/dkp/conductor">Conductor</a></li></ul></div><div class="chooser" id="localizer"><div class="chooser-current"><a class="chooser-title">English</a><svg class="chooser-svg" id="localizer-svg"><path class="pointer" d="m 13,6 -5,5 -5,-5 z" fill="#858585"></path></svg></div><ul class="chooser-list" id="localizer-list"><li class="chooser-list-item"><a href="/dcosdocs/mesosphere/dcos/cn">中文 (简体)</a></li></ul></div><section class="header__search" role="search"><form class="header__search-form" action="/search/"><input class="header__search-input" id="header-search-input" tabindex="1" type="text" name="q" placeholder="Search"><input type="hidden" name="hFR[scope][0]" value="DC/OS 2.2"><label class="header__search-label" for="header-search-input"><i class="header__icon" data-feather="search"></i></label></form></section></header><div class="header-dropdown"><ul class="header-dropdown__list"><li class="header-dropdown__top-item"><div>DKP</div></li><li class="header-dropdown__item"><a href="/dkp/konvoy">Konvoy</a></li><li class="header-dropdown__item"><a href="/dkp/konvoy/partner-solutions">Partner Solutions</a></li><li class="header-dropdown__item"><a href="/dkp/kommander">Kommander</a></li><li class="header-dropdown__item"><a href="/dkp/dispatch">Dispatch</a></li><li class="header-dropdown__item"><a href="/dkp/kaptain">Kaptain</a></li><li class="header-dropdown__item"><a href="/dkp/conductor">Conductor</a></li><li class="header-dropdown__top-item"><div>Mesosphere</div></li><li class="header-dropdown__item header-dropdown__item--active"><a href="/mesosphere/dcos">DC/OS</a></li><li class="header-dropdown__item"><a href="/dcosdocs/mesosphere/dcos/services">DC/OS Services</a></li><li class="header-dropdown__item"><a href="https://support.d2iq.com">Support</a></li></ul></div><div class="layout__sidebar layout__drawer"><section class="sidebar"><header class="sidebar__header"><div class="sidebar__dropdown"><ul><li><a href="/dcosdocs/mesosphere/dcos/2.2/installing/evaluation/universal-installer-0.3/azure/azure-remote-region">Mesosphere DC/OS 2.2.0</a></li><li><a href="/dcosdocs/mesosphere/dcos/2.1/installing/evaluation/universal-installer-0.3/azure/azure-remote-region">Mesosphere DC/OS 2.1.0</a></li><li><a href="/dcosdocs/mesosphere/dcos/2.0/installing/evaluation">Mesosphere DC/OS 2.0</a></li><li><a href="/dcosdocs/mesosphere/dcos/1.13/installing/evaluation">Mesosphere DC/OS 1.13</a></li></ul><div class="toggle"><p><span class="title">DC/OS</span><span class="version"> 2.2</span></p><i data-feather="chevron-down"></i></div></div></header><nav class="sidebar_nav" role="navigation"><ul><li><a class="d0" href="/dcosdocs/mesosphere/dcos/2.2/release-notes/"><i data-feather="chevron-right"></i>Release Notes</a></li><li><a class="d0" href="/dcosdocs/mesosphere/dcos/2.2/overview/"><i data-feather="chevron-right"></i>Overview</a></li><li class="active"><a class="d0" href="/dcosdocs/mesosphere/dcos/2.2/installing/"><i data-feather="chevron-right"></i>Installing</a></li><ul><li class="active"><a class="d1" href="/dcosdocs/mesosphere/dcos/2.2/installing/evaluation/"><i data-feather="chevron-right"></i>Cloud Installation</a></li><ul><li><a class="d2" href="/dcosdocs/mesosphere/dcos/2.2/installing/evaluation/universal-installer-0.2/"><i data-feather="chevron-right"></i>Deprecated Universal Installer 0.2</a></li><li class="active"><a class="d2" href="/dcosdocs/mesosphere/dcos/2.2/installing/evaluation/universal-installer-0.3/"><i data-feather="chevron-right"></i>Universal Installer 0.3</a></li><ul><li><a class="d3" href="/dcosdocs/mesosphere/dcos/2.2/installing/evaluation/universal-installer-0.3/aws/"><i data-feather="chevron-right"></i>AWS</a></li><li class="active"><a class="d3" href="/dcosdocs/mesosphere/dcos/2.2/installing/evaluation/universal-installer-0.3/azure/"><i data-feather="chevron-right"></i>Azure</a></li><ul><li class="active active-on"><a class="d4" href="/dcosdocs/mesosphere/dcos/2.2/installing/evaluation/universal-installer-0.3/azure/azure-remote-region/">Azure Multi-Region Support</a></li><li><a class="d4" href="/dcosdocs/mesosphere/dcos/2.2/installing/evaluation/universal-installer-0.3/azure/advanced-azure/">Configuration Reference</a></li></ul><li><a class="d3" href="/dcosdocs/mesosphere/dcos/2.2/installing/evaluation/universal-installer-0.3/gcp/"><i data-feather="chevron-right"></i>GCP</a></li></ul></ul><li><a class="d1" href="/dcosdocs/mesosphere/dcos/2.2/installing/production/"><i data-feather="chevron-right"></i>On-Prem Installation</a></li><li><a class="d1" href="/dcosdocs/mesosphere/dcos/2.2/installing/installation-faq/">Frequently Asked Questions</a></li><li><a class="d1" href="/dcosdocs/mesosphere/dcos/2.2/installing/troubleshooting/">Troubleshooting</a></li></ul><li><a class="d0" href="/dcosdocs/mesosphere/dcos/2.2/gui/"><i data-feather="chevron-right"></i>GUI</a></li><li><a class="d0" href="/dcosdocs/mesosphere/dcos/2.2/cli/"><i data-feather="chevron-right"></i>CLI</a></li><li><a class="d0" href="/dcosdocs/mesosphere/dcos/2.2/administering-clusters/"><i data-feather="chevron-right"></i>Administering Clusters</a></li><li><a class="d0" href="/dcosdocs/mesosphere/dcos/2.2/networking/"><i data-feather="chevron-right"></i>Networking</a></li><li><a class="d0" href="/dcosdocs/mesosphere/dcos/2.2/security/"><i data-feather="chevron-right"></i>Security</a></li><li><a class="d0" href="/dcosdocs/mesosphere/dcos/2.2/storage/"><i data-feather="chevron-right"></i>Storage</a></li><li><a class="d0" href="/dcosdocs/mesosphere/dcos/2.2/metrics/"><i data-feather="chevron-right"></i>Metrics</a></li><li><a class="d0" href="/dcosdocs/mesosphere/dcos/2.2/monitoring/"><i data-feather="chevron-right"></i>Monitoring, Logging, and Debugging</a></li><li><a class="d0" href="/dcosdocs/mesosphere/dcos/2.2/multi-tenancy/"><i data-feather="chevron-right"></i>Multi-Tenancy for DC/OS Clusters</a></li><li><a class="d0" href="/dcosdocs/mesosphere/dcos/2.2/hybrid-cloud/"><i data-feather="chevron-right"></i>Hybrid Cloud</a></li><li><a class="d0" href="/dcosdocs/mesosphere/dcos/2.2/deploying-jobs/"><i data-feather="chevron-right"></i>Deploying Jobs</a></li><li><a class="d0" href="/dcosdocs/mesosphere/dcos/2.2/deploying-services/"><i data-feather="chevron-right"></i>Deploying Services and Pods</a></li><li><a class="d0" href="/dcosdocs/mesosphere/dcos/2.2/tutorials/"><i data-feather="chevron-right"></i>Tutorials</a></li><li><a class="d0" href="/dcosdocs/mesosphere/dcos/2.2/api/"><i data-feather="chevron-right"></i>API Reference</a></li><li><a class="d0" href="/dcosdocs/mesosphere/dcos/2.2/developing-services/"><i data-feather="chevron-right"></i>Developing DC/OS Services</a></li><li><a class="d0" href="/dcosdocs/mesosphere/dcos/2.2/archives/">Access Documentation Archives</a></li></ul></nav><footer class="sidebar__footer"><div class="sidebar__footer-links"><a href="https://d2iq.com/terms/">Terms of Service</a><a href="https://d2iq.com/privacy/">Privacy Policy</a></div><a class="sidebar__footer-copyright" href="https://d2iq.com/">&copy; 2021 D2iQ, Inc. All rights reserved.</a></footer></section></div><div class="layout__content" role="main"><main class="content"><div class="content__container content__container--with-sections"><div class="content__header"><div class="content__header__row"><h1 class="content__header-title">Multi-Region DC/OS on Azure using the Universal Installer</h1><p class="badge badge--content-header badge--enterprise">ENTERPRISE</p></div><h4 class="content__header-description">Guide for DC/OS on Azure using the Universal Installer adding a remote region.</h4><div class="actions"><ul class="actions__list"><li class="actions__item"><button class="actions__link" onclick="javascript:window.print()"><i class="actions__icon" data-feather="printer"></i><span class="actions__text">Print</span></button></li><li class="actions__item"><a class="actions__link" href="https://github.com/mesosphere/dcos-docs-site/tree/master/pages/dcosdocs/mesosphere/dcos/2.2/installing/evaluation/universal-installer-0.3/azure/azure-remote-region/index.md" target="_blank"><i class="actions__icon" data-feather="github"></i><span class="actions__text">Contribute</span></a></li><li class="actions__item"><a class="actions__link" href="https://dcos-community.slack.com/" target="_blank"><i class="actions__icon" data-feather="slack"></i><span class="actions__text">Discuss</span></a></li><li class="actions__item"><a class="actions__link" href="https://jira.d2iq.com/secure/CreateIssueDetails!init.jspa?pid=14105&amp;issuetype=1&amp;summary=Feedback+for+Multi-Region+DC/OS on Azure using the Universal Installer&amp;description=Source:%20https://docs.d2iq.com/dcosdocs/mesosphere/dcos/2.2/installing/evaluation/universal-installer-0.3/azure/azure-remote-region&amp;labels=documentation&amp;labels=needs_triage&amp;components=19804&amp;priority=3&amp;customfield_12300=44" target="_blank"><i class="actions__icon" data-feather="message-square"></i><span class="actions__text">Feedback</span></a></li></ul></div></div><article class="content__article"><p>This guide expects that you already have a running DC/OS cluster based on Universal Installer <code>0.3</code>. To learn more about running DC/OS with the Universal Installer have a look into the <a href="/dcosdocs/mesosphere/dcos//installing/evaluation/azure/">Guide for DC/OS on Azure using the Universal Installer</a>.</p>
<p>You will learn how to place additional infrastructure into an Azure remote region. Remote regions will be connected to each other by using the peering functionality of Azure VNETs.</p>
<h1 id="prerequisites"><a class="content__anchor" href="#prerequisites" aria-hidden="true"><i data-feather="bookmark"></i></a>Prerequisites</h1>
<ul>
<li>A running DC/OS Enterprise cluster set up with Universal Installer 0.2 modules</li>
<li>A subnet range for your remote region</li>
</ul>
<h1 id="getting-started-with-remote-region"><a class="content__anchor" href="#getting-started-with-remote-region" aria-hidden="true"><i data-feather="bookmark"></i></a>Getting started with remote region</h1>
<p>We expect your already running DC/OS clusters <code>main.tf</code> will look similar to this example. To deploy a remote region we have to do some changes to your <code>main.tf</code></p>
<pre><code class="language-hcl">provider &quot;azurerm&quot; {
  features {}
}

# Used to determine your public IP for forwarding rules
data &quot;http&quot; &quot;whatismyip&quot; {
  url = &quot;http://whatismyip.akamai.com/&quot;
}

module &quot;dcos&quot; {
  source  = &quot;dcos-terraform/dcos/aws&quot;
  version = &quot;~&gt; 0.3.0&quot;

  providers = {
    azurerm = azurerm
  }

  location                          = &quot;West US&quot;
  avset_platform_fault_domain_count = 3

  cluster_name        = &quot;my-dcos-demo&quot;
  ssh_public_key_file = &quot;&lt;path-to-public-key-file&gt;&quot;
  admin_ips           = [&quot;${data.http.whatismyip.body}/32&quot;]

  num_masters        = 3
  num_private_agents = 2
  num_public_agents  = 1

  dcos_version = &quot;&quot;

  dcos_variant              = &quot;ee&quot;
  dcos_license_key_contents = &quot;${file(&quot;./license.txt&quot;)}&quot;

  # Make sure to set your credentials if you do not want the default EE
  # dcos_superuser_username      = &quot;superuser-name&quot;
  # dcos_superuser_password_hash = &quot;${file(&quot;./dcos_superuser_password_hash.sha512&quot;)}&quot;

  dcos_instance_os = &quot;centos_7.6&quot;
}

output &quot;masters-ips&quot; {
  value = module.dcos.masters-ips
}

output &quot;cluster-address&quot; {
  value = module.dcos.masters-loadbalancer
}

output &quot;public-agents-loadbalancer&quot; {
  value = module.dcos.public-agents-loadbalancer
}
</code></pre>
<h2 id="shared-config-options"><a class="content__anchor" href="#shared-config-options" aria-hidden="true"><i data-feather="bookmark"></i></a>Shared config options</h2>
<p>To create the remote region and its infrastructure we will use the same underlying modules as in our master region. This also means there will be some information needed for both infrastructures like <code>cluster_name</code>, <code>admin_ips</code> and <code>ssh_public_key_file</code>. To make the operation easier you should define local variables in your <code>main.tf</code> that will be used in every module.</p>
<pre><code class="language-hcl">#...

// lets define variables which are shared between all regions
locals {
  ssh_public_key_file = &quot;~/.ssh/id_rsa.pub&quot;
  cluster_name        = &quot;my-dcos-demo&quot;
  admin_ips           = [&quot;${data.http.whatismyip.body}/32&quot;]
}

#...
</code></pre>
<h3 id="internal-subnetworks"><a class="content__anchor" href="#internal-subnetworks" aria-hidden="true"><i data-feather="bookmark"></i></a>Internal subnetworks</h3>
<p>Part of the shared information is which internal subnets are used in your infrastructure. If you did not specify <code>subnet_range</code>, terraform uses the default which is <code>172.12.0.0/16</code>. The remote region we want to specify needs its own subnet.</p>
<p class="message--important"><strong>IMPORTANT:</strong> You should not take <code>172.17.0.0/16</code>, it is dockers internal network default which will lead to problems.</p>
<p>To have a clear separation between our master and our remote regions we will take <code>10.128.0.0/16</code> as our remote regions subnet. Also, we will use a <a href="https://www.terraform.io/docs/configuration-0-11/variables.html#maps">map variable</a> to assign the networks to regions. This will make it easier when adding additional regions in the future.</p>
<p>The locals section will now look like this</p>
<pre><code class="language-hcl">#...

// lets define variables which are shared between all regions
locals {
  ssh_public_key_file       = &quot;~/.ssh/id_rsa.pub&quot;
  cluster_name              = &quot;my-dcos-demo&quot;
  admin_ips                 = [&quot;${data.http.whatismyip.body}/32&quot;]

  region_networks = {
    // dont use 172.17/26 as its used by docker.
    &quot;master&quot;    = &quot;172.12.0.0/16&quot; // this is the default
    &quot;West US 2&quot; = &quot;10.128.0.0/16&quot;
  }
}

#...
</code></pre>
<h2 id="the-remote-region"><a class="content__anchor" href="#the-remote-region" aria-hidden="true"><i data-feather="bookmark"></i></a>The remote region</h2>
<p>Before we start changing values within the <code>dcos</code> module we will append the infrastructure definition of the remote region to your <code>main.tf</code>. In our example case we only want to have private agents in our remote region, and both private and public agents can be put in a remote region.</p>
<p class="message--important"><strong>IMPORTANT:</strong> Running master instances in remote regions is not supported.</p>
<p>To only start private agents we will set <code>num_bootstrap = 0</code>, <code>num_masters = 0</code> and <code>num_public_agents = 0</code>.</p>
<p>Another important topic to mention is naming. To distinguish between instances of your main and your remote region we introduced the <code>name_prefix</code> variable which allows you to add a prefix to the name of every resource. In this example we set the <code>name_prefix</code> to the short name of the remote region.</p>
<p>In the following example you will also find the <a href="#shared-config-options">shared config options</a> being used in the module call referenced by e.g. <code>local.ssh_public_key_file</code>.</p>
<pre><code class="language-hcl">#...

module &quot;dcos-wus2&quot; {
  source  = &quot;dcos-terraform/infrastructure/azurerm&quot;
  version = &quot;~&gt; 0.3.0&quot;

  providers = {
    azurerm = azurerm
  }

  location                          = &quot;West US 2&quot;
  avset_platform_fault_domain_count = 2
  subnet_range                      = local.region_networks[&quot;West US 2&quot;]

  admin_ips   = local.admin_ips
  name_prefix = &quot;wus2&quot;

  cluster_name = local.cluster_name

  num_bootstrap      = 0
  num_masters        = 0
  num_private_agents = 1
  num_public_agents  = 0

  ssh_public_key_file    = local.ssh_public_key_file
}

</code></pre>
<h2 id="peering-to-the-main-dcos-region"><a class="content__anchor" href="#peering-to-the-main-dcos-region" aria-hidden="true"><i data-feather="bookmark"></i></a>Peering to the main DC/OS region</h2>
<p>We now need to establish a connection between the two infrastructures. The Universal Installer provides a module for this task. In this module we reference data from both infrastructures the main region holding DC/OS masters and the remote region holding your remote private agents.</p>
<p>The only information this module needs to receive is the output of our <code>dcos</code> and <code>dcos-wus2</code> modules. We will append this module to the end of your <code>main.tf</code></p>
<p>Here is the example vnet-peering-section</p>
<pre><code class="language-hcl">#...

module &quot;vnet-connection-master-wus2&quot; {
  source  = &quot;dcos-terraform/vnet-peering/azurerm&quot;
  version = &quot;~&gt; 0.3.0&quot;

  providers = {
    azurerm = azurerm
  }

  cluster_name               = local.cluster_name
  local_region_network       = &quot;master&quot;
  local_resource_group_name  = module.dcos.infrastructure.resource_group_name
  local_vnet_name            = module.dcos.infrastructure.vnet_name
  local_vnet_id              = module.dcos.infrastructure.vnet_id
  remote_region_network      = &quot;wus2&quot;
  remote_resource_group_name = module.dcos-wus2.resource_group_name
  remote_vnet_name           = module.dcos-wus2.vnet_name
  remote_vnet_id             = module.dcos-wus2.vnet_id
}
</code></pre>
<h2 id="changes-to-dcos-module"><a class="content__anchor" href="#changes-to-dcos-module" aria-hidden="true"><i data-feather="bookmark"></i></a>Changes to dcos module</h2>
<p>At this point its time to do changes to your <code>dcos</code> module so it knows about the remote region and is able to install the remote agents.</p>
<ol>
<li>
<p>Choose a subnet range. In general this change is not needed but we wanted to make your example pretty specific.</p>
<p><code>subnet_range = &quot;local.region_networks[&quot;master&quot;]</code></p>
</li>
<li>
<p>Change the cluster_name. As this is a shared resource we will make use of the local variable.</p>
<p><code>cluster_name = &quot;local.cluster_name</code></p>
</li>
<li>
<p>List the SSH key. This is also a shared resource and we can make use of the local variable</p>
<p><code>ssh_public_key_file = &quot;local.ssh_public_key_file</code></p>
</li>
<li>
<p>Add the admin IPs following the same pattern.</p>
<p>`admin_ips = local.admin_ips</p>
</li>
<li>
<p>Add the private agents. This nearly the most important new variable. This tells the DC/OS installation module which other agents need to be installed.</p>
<p><code>additional_private_agent_ips = module.dcos-wus2.private_agents.private_ips</code></p>
</li>
</ol>
<h3 id="example-dcos-module"><a class="content__anchor" href="#example-dcos-module" aria-hidden="true"><i data-feather="bookmark"></i></a>Example dcos module</h3>
<p>After the changes above got applied your <code>dcos</code> module should look like this</p>
<pre><code class="language-hcl">module &quot;dcos&quot; {
  source  = &quot;dcos-terraform/dcos/azurerm&quot;
  version = &quot;~&gt; 0.3.0&quot;

  providers = {
    azure = &quot;azure&quot;
  }

  location                          = &quot;West US&quot;
  avset_platform_fault_domain_count = 3
  subnet_range                      = local.region_networks[&quot;master&quot;]

  cluster_name        = local.cluster_name
  ssh_public_key_file = local.ssh_public_key_file
  admin_ips           = local.admin_ips

  num_masters        = 3
  num_private_agents = 2
  num_public_agents  = 1

  dcos_version = &quot;&quot;

  dcos_variant              = &quot;ee&quot;
  dcos_license_key_contents = &quot;${file(&quot;./license.txt&quot;)}&quot;

  # Make sure to set your credentials if you do not want the default EE
  # dcos_superuser_username      = &quot;superuser-name&quot;
  # dcos_superuser_password_hash = &quot;${file(&quot;./dcos_superuser_password_hash.sha512&quot;)}&quot;

  dcos_instance_os = &quot;centos_7.6&quot;

  additional_private_agent_ips = module.dcos-wus2.private_agents.private_ips
}
</code></pre>
<h1 id="full-maintf-example"><a class="content__anchor" href="#full-maintf-example" aria-hidden="true"><i data-feather="bookmark"></i></a>Full main.tf example</h1>
<p>Here is the complete <code>main.tf</code> you should see once you completed this guide.</p>
<pre><code class="language-hcl">provider &quot;azurerm&quot; {
  features {}
}

# Used to determine your public IP for forwarding rules
data &quot;http&quot; &quot;whatismyip&quot; {
  url = &quot;http://whatismyip.akamai.com/&quot;
}


// lets define variables which are shared between all regions
locals {
  ssh_public_key_file       = &quot;~/.ssh/id_rsa.pub&quot;
  cluster_name              = &quot;my-dcos-demo&quot;
  admin_ips                 = [&quot;${data.http.whatismyip.body}/32&quot;]

  region_networks = {
    // dont use 172.17/26 as its used by docker.
    &quot;master&quot;    = &quot;172.12.0.0/16&quot; // this is the default
    &quot;West US 2&quot; = &quot;172.13.0.0/16&quot;
  }
}

module &quot;dcos&quot; {
  source  = &quot;dcos-terraform/dcos/azurerm&quot;
  version = &quot;~&gt; 0.3.0&quot;

  providers = {
    azurerm = azurerm
  }

  location                          = &quot;West US&quot;
  avset_platform_fault_domain_count = 3
  subnet_range                      = local.region_networks[&quot;master&quot;]

  cluster_name        = local.cluster_name
  ssh_public_key_file = local.ssh_public_key_file
  admin_ips           = local.admin_ips

  num_masters        = 3
  num_private_agents = 2
  num_public_agents  = 1

  dcos_version = &quot;&quot;

  dcos_variant              = &quot;ee&quot;
  dcos_license_key_contents = &quot;${file(&quot;./license.txt&quot;)}&quot;

  # Make sure to set your credentials if you do not want the default EE
  # dcos_superuser_username      = &quot;superuser-name&quot;
  # dcos_superuser_password_hash = &quot;${file(&quot;./dcos_superuser_password_hash.sha512&quot;)}&quot;

  dcos_instance_os = &quot;centos_7.6&quot;

  additional_private_agent_ips = module.dcos-usw2.private_agents_private_ips
}

output &quot;masters-ips&quot; {
  value = module.dcos.masters-ips
}

output &quot;cluster-address&quot; {
  value = module.dcos.masters-loadbalancer
}

output &quot;public-agents-loadbalancer&quot; {
  value = module.dcos.public-agents-loadbalancer
}

module &quot;dcos-usw2&quot; {
  source  = &quot;dcos-terraform/infrastructure/azurerm&quot;
  version = &quot;~&gt; 0.3.0&quot;

  providers = {
    azurerm = azurerm
  }

  location                          = &quot;West US 2&quot;
  avset_platform_fault_domain_count = 2
  subnet_range                      = local.region_networks[&quot;West US 2&quot;]

  admin_ips   = local.admin_ips
  name_prefix = &quot;usw2&quot;

  cluster_name = local.cluster_name

  num_bootstrap      = 0
  num_masters        = 0
  num_private_agents = 1
  num_public_agents  = 0

  ssh_public_key_file    = local.ssh_public_key_file
}

module &quot;vnet-connection-master-usw2&quot; {
  source  = &quot;dcos-terraform/vnet-peering/azurerm&quot;
  version = &quot;~&gt; 0.3.0&quot;

  providers = {
    azurerm = azurerm
  }

  cluster_name               = local.cluster_name
  local_region_network       = &quot;master&quot;
  local_resource_group_name  = module.dcos.infrastructure_resource_group_name
  local_vnet_name            = module.dcos.infrastructure_vnet_name
  local_vnet_id              = module.dcos.infrastructure_vnet_id
  remote_region_network      = &quot;usw2&quot;
  remote_resource_group_name = module.dcos-usw2.resource_group_name
  remote_vnet_name           = module.dcos-usw2.vnet_name
  remote_vnet_id             = module.dcos-usw2.vnet_id
}
</code></pre>
</article></div><aside class="content__sections"><div class="content__sections-list-container"><ul class="content__sections-list"><li class="content__sections-item content__sections-item--h1"><a href="#prerequisites">Prerequisites</a></li><li class="content__sections-item content__sections-item--h1"><a href="#getting-started-with-remote-region">Getting started with remote region</a></li><li class="content__sections-item content__sections-item--h2"><a href="#shared-config-options">Shared config options</a></li><li class="content__sections-item content__sections-item--h2"><a href="#the-remote-region">The remote region</a></li><li class="content__sections-item content__sections-item--h2"><a href="#peering-to-the-main-dcos-region">Peering to the main DC/OS region</a></li><li class="content__sections-item content__sections-item--h2"><a href="#changes-to-dcos-module">Changes to dcos module</a></li><li class="content__sections-item content__sections-item--h1"><a href="#full-maintf-example">Full main.tf example</a></li></ul></div></aside></main></div></div><script src="/assets/js/jquery-3.2.1.js"></script><script src="/assets/js/clipboard.js"></script><script src="/assets/js/prism.js"></script><script src="/js/main.js"></script></body></html>