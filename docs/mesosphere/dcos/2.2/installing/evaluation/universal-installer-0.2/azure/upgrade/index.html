<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width" initial-scale="1" user-scalable="no"><title>Upgrade to Universal Installer 0.3 - D2iQ Docs</title><meta name="description" content="Guide to Upgrade Mesosphere Universal Installer to version 0.3"><link rel="apple-touch-icon" sizes="180x180" href="/dcosdocs/assets/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/dcosdocs/assets/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/dcosdocs/assets/favicon-16x16.png"><link rel="stylesheet" type="text/css" href="/dcosdocs/css/styles.css"><link rel="search" type="application/opensearchdescription+xml" href="/dcosdocs/assets/opensearch.xml" title="Search"><link href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,500,500i,700,700i" rel="stylesheet"><script src="https://unpkg.com/feather-icons/dist/feather.min.js"></script><script>window.analytics||(window.analytics=[]),window.analytics.methods=["identify","track","trackLink","trackForm","trackClick","trackSubmit","page","pageview","ab","alias","ready","group","on","once","off"],window.analytics.factory=function(t){return function(){var a=Array.prototype.slice.call(arguments);return a.unshift(t),window.analytics.push(a),window.analytics}};for(var i=0;i<window.analytics.methods.length;i++){var method=window.analytics.methods[i];window.analytics[method]=window.analytics.factory(method)}window.analytics.load=function(t){var a=document.createElement("script");a.type="text/javascript",a.async=!0,a.src=("https:"===document.location.protocol?"https://":"http://")+"d2dq2ahtl5zl1z.cloudfront.net/analytics.js/v1/"+t+"/analytics.min.js";var n=document.getElementsByTagName("script")[0];n.parentNode.insertBefore(a,n)},window.analytics.SNIPPET_VERSION="2.0.8",
window.analytics.load("7sgtwqvuai");
window.analytics.page();</script><noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-PBJ84KX" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript><script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src='//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-PBJ84KX');</script></head><body><div class="layout"><header class="header"><a class="header__drawer"><i class="header__icon" data-feather="menu"></i></a><a class="header__logo" href="/"><img class="header__logo--mobile" src="/dcosdocs/assets/D2iQ_Logotype_Color_Positive_Documentation.svg" alt="D2IQ"><img class="header__logo--desktop" src="/dcosdocs/assets/D2iQ_Logotype_Color_Positive_Documentation.svg" alt="D2IQ"></a><div class="header__main"><div class="header__dropdown"><img class="header__dropdown-icon" src="/dcosdocs/assets/D2IQ_Logotype_Color_Positive.png" alt="D2iQ"><strong>DC/OS Documentation</strong><i data-feather="chevron-down"></i></div><nav class="header__menu"><ul class="header__menu-list"><li class="header__menu-item"><a href="/mesosphere/dcos">DC/OS</a></li><li class="header__menu-item"><a href="/dcosdocs/mesosphere/dcos/services">Services</a></li><li class="header__menu-item"><a href="https://support.d2iq.com">Support</a></li></ul></nav></div><div class="chooser" id="localizer"><div class="chooser-current"><a class="chooser-title">English</a><svg class="chooser-svg" id="localizer-svg"><path class="pointer" d="m 13,6 -5,5 -5,-5 z" fill="#858585"></path></svg></div><ul class="chooser-list" id="localizer-list"><li class="chooser-list-item"><a href="/dcosdocs/mesosphere/dcos/cn">中文 (简体)</a></li></ul></div><section class="header__search" role="search"><form class="header__search-form" action="/search/"><input class="header__search-input" id="header-search-input" tabindex="1" type="text" name="q" placeholder="Search"><input type="hidden" name="hFR[scope][0]" value="DC/OS 2.2"><label class="header__search-label" for="header-search-input"><i class="header__icon" data-feather="search"></i></label></form></section></header><div class="header-dropdown"><ul class="header-dropdown__list"><li class="header-dropdown__top-item"><div>DKP</div></li><li class="header-dropdown__item"><a href="/dkp/konvoy">Konvoy</a></li><li class="header-dropdown__item"><a href="/dkp/kommander">Kommander</a></li><li class="header-dropdown__item"><a href="/dkp/dispatch">Dispatch</a></li><li class="header-dropdown__item"><a href="/dkp/kaptain">Kaptain</a></li><li class="header-dropdown__top-item"><div>Mesosphere</div></li><li class="header-dropdown__item header-dropdown__item--active"><a href="/mesosphere/dcos">DC/OS</a></li><li class="header-dropdown__item"><a href="/dcosdocs/mesosphere/dcos/services">DC/OS Services</a></li><li class="header-dropdown__item"><a href="https://support.d2iq.com">Support</a></li></ul></div><div class="layout__sidebar layout__drawer"><section class="sidebar"><header class="sidebar__header"><div class="sidebar__dropdown"><ul><li><a href="/dcosdocs/mesosphere/dcos/2.2/installing/evaluation/universal-installer-0.2/azure/upgrade">Mesosphere DC/OS 2.2.0</a></li><li><a href="/dcosdocs/mesosphere/dcos/2.1/installing/evaluation/universal-installer-0.2/azure/upgrade">Mesosphere DC/OS 2.1.0</a></li><li><a href="/dcosdocs/mesosphere/dcos/2.0/installing/evaluation">Mesosphere DC/OS 2.0</a></li><li><a href="/dcosdocs/mesosphere/dcos/1.13/installing/evaluation">Mesosphere DC/OS 1.13</a></li></ul><div class="toggle"><p><span class="title">DC/OS</span><span class="version"> 2.2</span></p><i data-feather="chevron-down"></i></div></div></header><nav class="sidebar_nav" role="navigation"><ul><li><a class="d0" href="/dcosdocs/mesosphere/dcos/2.2/release-notes/"><i data-feather="chevron-right"></i>Release Notes</a></li><li><a class="d0" href="/dcosdocs/mesosphere/dcos/2.2/overview/"><i data-feather="chevron-right"></i>Overview</a></li><li class="active"><a class="d0" href="/dcosdocs/mesosphere/dcos/2.2/installing/"><i data-feather="chevron-right"></i>Installing</a></li><ul><li class="active"><a class="d1" href="/dcosdocs/mesosphere/dcos/2.2/installing/evaluation/"><i data-feather="chevron-right"></i>Cloud Installation</a></li><ul><li class="active"><a class="d2" href="/dcosdocs/mesosphere/dcos/2.2/installing/evaluation/universal-installer-0.2/"><i data-feather="chevron-right"></i>Deprecated Universal Installer 0.2</a></li><ul><li><a class="d3" href="/dcosdocs/mesosphere/dcos/2.2/installing/evaluation/universal-installer-0.2/aws/"><i data-feather="chevron-right"></i>AWS</a></li><li class="active"><a class="d3" href="/dcosdocs/mesosphere/dcos/2.2/installing/evaluation/universal-installer-0.2/azure/"><i data-feather="chevron-right"></i>Azure</a></li><ul><li><a class="d4" href="/dcosdocs/mesosphere/dcos/2.2/installing/evaluation/universal-installer-0.2/azure/azure-remote-region/">Azure Multi-Region Support</a></li><li><a class="d4" href="/dcosdocs/mesosphere/dcos/2.2/installing/evaluation/universal-installer-0.2/azure/advanced-azure/">Configuration Reference</a></li><li class="active active-on"><a class="d4" href="/dcosdocs/mesosphere/dcos/2.2/installing/evaluation/universal-installer-0.2/azure/upgrade/">Upgrade</a></li></ul><li><a class="d3" href="/dcosdocs/mesosphere/dcos/2.2/installing/evaluation/universal-installer-0.2/gcp/"><i data-feather="chevron-right"></i>GCP</a></li><li><a class="d3" href="/dcosdocs/mesosphere/dcos/2.2/installing/evaluation/universal-installer-0.2/community-supported-methods/"><i data-feather="chevron-right"></i>Other Installation methods</a></li></ul><li><a class="d2" href="/dcosdocs/mesosphere/dcos/2.2/installing/evaluation/universal-installer-0.3/"><i data-feather="chevron-right"></i>Universal Installer 0.3</a></li></ul><li><a class="d1" href="/dcosdocs/mesosphere/dcos/2.2/installing/production/"><i data-feather="chevron-right"></i>On-Prem Installation</a></li><li><a class="d1" href="/dcosdocs/mesosphere/dcos/2.2/installing/installation-faq/">Frequently Asked Questions</a></li><li><a class="d1" href="/dcosdocs/mesosphere/dcos/2.2/installing/troubleshooting/">Troubleshooting</a></li></ul><li><a class="d0" href="/dcosdocs/mesosphere/dcos/2.2/gui/"><i data-feather="chevron-right"></i>GUI</a></li><li><a class="d0" href="/dcosdocs/mesosphere/dcos/2.2/cli/"><i data-feather="chevron-right"></i>CLI</a></li><li><a class="d0" href="/dcosdocs/mesosphere/dcos/2.2/administering-clusters/"><i data-feather="chevron-right"></i>Administering Clusters</a></li><li><a class="d0" href="/dcosdocs/mesosphere/dcos/2.2/networking/"><i data-feather="chevron-right"></i>Networking</a></li><li><a class="d0" href="/dcosdocs/mesosphere/dcos/2.2/security/"><i data-feather="chevron-right"></i>Security</a></li><li><a class="d0" href="/dcosdocs/mesosphere/dcos/2.2/storage/"><i data-feather="chevron-right"></i>Storage</a></li><li><a class="d0" href="/dcosdocs/mesosphere/dcos/2.2/metrics/"><i data-feather="chevron-right"></i>Metrics</a></li><li><a class="d0" href="/dcosdocs/mesosphere/dcos/2.2/monitoring/"><i data-feather="chevron-right"></i>Monitoring, Logging, and Debugging</a></li><li><a class="d0" href="/dcosdocs/mesosphere/dcos/2.2/multi-tenancy/"><i data-feather="chevron-right"></i>Multi-Tenancy for DC/OS Clusters</a></li><li><a class="d0" href="/dcosdocs/mesosphere/dcos/2.2/hybrid-cloud/"><i data-feather="chevron-right"></i>Hybrid Cloud</a></li><li><a class="d0" href="/dcosdocs/mesosphere/dcos/2.2/deploying-jobs/"><i data-feather="chevron-right"></i>Deploying Jobs</a></li><li><a class="d0" href="/dcosdocs/mesosphere/dcos/2.2/deploying-services/"><i data-feather="chevron-right"></i>Deploying Services and Pods</a></li><li><a class="d0" href="/dcosdocs/mesosphere/dcos/2.2/tutorials/"><i data-feather="chevron-right"></i>Tutorials</a></li><li><a class="d0" href="/dcosdocs/mesosphere/dcos/2.2/api/"><i data-feather="chevron-right"></i>API Reference</a></li><li><a class="d0" href="/dcosdocs/mesosphere/dcos/2.2/developing-services/"><i data-feather="chevron-right"></i>Developing DC/OS Services</a></li><li><a class="d0" href="/dcosdocs/mesosphere/dcos/2.2/archives/">Access Documentation Archives</a></li></ul></nav><footer class="sidebar__footer"><div class="sidebar__footer-links"><a href="https://d2iq.com/terms/">Terms of Service</a><a href="https://d2iq.com/privacy/">Privacy Policy</a></div><a class="sidebar__footer-copyright" href="https://d2iq.com/">&copy; 2022 D2iQ, Inc. All rights reserved.</a></footer></section></div><div class="layout__content" role="main"><main class="content"><div class="content__container content__container--with-sections"><div class="content__header"><div class="content__header__row"><h1 class="content__header-title">Upgrade to Universal Installer 0.3</h1></div><h4 class="content__header-description">Guide to Upgrade Mesosphere Universal Installer to version 0.3</h4><div class="actions"><ul class="actions__list"><li class="actions__item"><button class="actions__link" onclick="javascript:window.print()"><i class="actions__icon" data-feather="printer"></i><span class="actions__text">Print</span></button></li><li class="actions__item"><a class="actions__link" href="https://github.com/mesosphere/dcos-docs-site/tree/main/pages/dcosdocs/mesosphere/dcos/2.2/installing/evaluation/universal-installer-0.2/azure/upgrade/index.md" target="_blank"><i class="actions__icon" data-feather="github"></i><span class="actions__text">Contribute</span></a></li></ul></div></div><article class="content__article"><h1 id="upgrade-universal-installer-02-to-03"><a class="content__anchor" href="#upgrade-universal-installer-02-to-03" aria-hidden="true"><i data-feather="bookmark"></i></a>Upgrade Universal Installer 0.2 to 0.3</h1>
<p>This guide helps you upgrading Universal Installer 0.2 to 0.3 to support terraform 0.12
With this guide we assume you’re running a DC/OS cluster similar to our example in the docs. More complex setup might need more care. But the here mentioned changes should also apply. Before doing this on your production cluster you should setup a test cluster in a similar way to make sure changes won’t render your cluster unresponsive.</p>
<h2 id="preparation"><a class="content__anchor" href="#preparation" aria-hidden="true"><i data-feather="bookmark"></i></a>Preparation</h2>
<p>Ideally you should use tfenv to switch between terraform versions but you can also do it by yourself. so tfenv use 0.12.25 means you need to replace your 0.11 terraform version with 0.12.25
We assume you’re using a clusters main.tf similar to this:</p>
<pre><code class="language-hcl">provider &quot;azurerm&quot; {}
# Used to determine your public IP for forwarding rules
data &quot;http&quot; &quot;whatismyip&quot; {
  url = &quot;http://whatismyip.akamai.com/&quot;
}
locals {
  cluster_name = &quot;generic-dcos-ee-demo&quot;
}
module &quot;dcos&quot; {
  source  = &quot;dcos-terraform/dcos/azurerm&quot;
  version = &quot;~&gt; 0.2.0&quot;
  providers = {
    azurerm = &quot;azurerm&quot;
  }
  location = &quot;West US&quot;
  cluster_name        = &quot;${local.cluster_name}&quot;
  ssh_public_key_file = &quot;~/.ssh/id_rsa.pub&quot;
  admin_ips           = [&quot;${data.http.whatismyip.body}/32&quot;]
  num_masters        = 1
  num_private_agents = 2
  num_public_agents  = 1
  dcos_instance_os = &quot;centos_7.6&quot;
  dcos_variant              = &quot;ee&quot;
  dcos_version              = &quot;2.2&quot;
  dcos_license_key_contents = &quot;${file(&quot;~/license.txt&quot;)}&quot;
  # provide a SHA512 hashed password, here &quot;deleteme&quot;
  dcos_superuser_password_hash = &quot;$6$rounds=656000$YSvuFmasQDXheddh$TpYlCxNHF6PbsGkjlK99Pwxg7D0mgWJ.y0hE2JKoa61wHx.1wtxTAHVRHfsJU9zzHWDoE08wpdtToHimNR9FJ/&quot;
  dcos_superuser_username      = &quot;demo-super&quot;
}
output &quot;masters_dns_name&quot; {
  description = &quot;This is the load balancer address to access the DC/OS UI&quot;
  value       = &quot;${module.dcos.masters-loadbalancer}&quot;
}
</code></pre>
<p>Make sure you’re using the latest modules and your state is properly updated:</p>
<pre><code>$ terraform init -upgrade
$ terraform apply
</code></pre>
<h2 id="translate-terraform-011-maintf-into-012"><a class="content__anchor" href="#translate-terraform-011-maintf-into-012" aria-hidden="true"><i data-feather="bookmark"></i></a>Translate terraform 0.11 <code>main.tf</code> into 0.12</h2>
<p>Now we switch to terraform 0.12.25 which offers us an option to translate terraform 0.11 code into terraform 0.12 code</p>
<pre><code>$ tfenv install 0.12.25
$ tfenv use 0.12.25
</code></pre>
<p>Translate into 0.12 code</p>
<pre><code>$ terraform 0.12upgrade
</code></pre>
<p>You must change the module version to 0.3.0:</p>
<p>change:</p>
<pre><code class="language-hcl">version = &quot;~&gt; 0.2.0&quot;
</code></pre>
<p>to:</p>
<pre><code class="language-hcl">version = &quot;~&gt; 0.3.0&quot;
</code></pre>
<p>As there where changes to the Azure provider we also have to add the features section:
Therefore replace:</p>
<pre><code class="language-hcl">provider &quot;azurerm&quot; {}
</code></pre>
<p>with:</p>
<pre><code class="language-hcl">provider &quot;azurerm&quot; {
  version = &quot;=2.14.0&quot;
  features {}
}
</code></pre>
<p>First we upgrade our modules to Universal Installer 0.3 ( version change from above)</p>
<pre><code>$ terraform init -upgrade
</code></pre>
<p>not every option might be properly translated. Lets check if our main.tf is valid.</p>
<pre><code>$ terraform validate
</code></pre>
<p>A known issue is the providers part:</p>
<pre><code class="language-hcl">providers = {
  azurerm = &quot;azurerm&quot;
}
</code></pre>
<p>it should look like this:</p>
<pre><code class="language-hcl">providers = {
  azurerm = azurerm
}
</code></pre>
<p>the important part is that the provider reference must be without quotes (&quot;&quot;)
You can find more information about tf 0.11 to 0.12 upgrade here: https://www.terraform.io/upgrade-guides/0-12.html</p>
<h2 id="start-the-upgrade-procedure"><a class="content__anchor" href="#start-the-upgrade-procedure" aria-hidden="true"><i data-feather="bookmark"></i></a>Start the upgrade procedure</h2>
<p>Now we apply the new modules to our previous terraform state.</p>
<h3 id="we-need-to-let-terraform-run-on-everything-except-load-balancers"><a class="content__anchor" href="#we-need-to-let-terraform-run-on-everything-except-load-balancers" aria-hidden="true"><i data-feather="bookmark"></i></a>We need to let terraform run on everything except load balancers</h3>
<p>Due to a needed change in the way the load balancer module is being used we must exclude it from the first apply:</p>
<pre><code>$ terraform apply $(terraform state list | grep -v module.loadbalancers | xargs printf -- '-target %s ')
</code></pre>
<p>We expect changes to <code>...</code> and `…``</p>
<p>After this was successful most of the infrastructure is updated</p>
<h3 id="import-load-balancers-rules-in-the-new-format"><a class="content__anchor" href="#import-load-balancers-rules-in-the-new-format" aria-hidden="true"><i data-feather="bookmark"></i></a>Import load balancers rules in the new format.</h3>
<p>The load balancer module had quite some changes about its addressing. Therefore we now need to create import statements from the current state, drop the old state for load balancer rules and reimport them into terraform.</p>
<pre><code>$ terraform state pull | jq -r '.resources[] | select(.module != null) |select(.module|startswith(&quot;module.dcos.module.dcos-infrastructure.module.loadbalancers&quot;)) | select(.type==&quot;azurerm_lb_rule&quot;)| . as $i | .instances[] | &quot;terraform import \&quot;&quot;+$i.module+&quot;.&quot;+$i.type+&quot;.&quot;+$i.name+&quot;[\\\&quot;&quot;+.attributes_flat.frontend_port+&quot;\\\&quot;]&quot; +&quot;\&quot; \&quot;&quot; + .attributes_flat.id + &quot;\&quot;&quot;' &gt; import_lb_rules.sh
</code></pre>
<p>In the next step we will drop the complete state for these load balancers. We must make sure that the previous commands ran successfully and stored the targetgroups and listeners.</p>
<p>In our example this looks like this:</p>
<pre><code>$ cat import_targetgroups.sh
terraform import &quot;module.dcos.module.dcos-infrastructure.module.loadbalancers.module.masters-internal.module.masters-internal.azurerm_lb_rule.load_balancer_rule[\&quot;80\&quot;]&quot; &quot;/subscriptions/12345678-1234-5678-abcd-abcdefghijkl/resourceGroups/generic-dcos-ee-demo/providers/Microsoft.Network/loadBalancers/int-generic-dcos-ee-demo/loadBalancingRules/load-balancer-rule-80&quot;
[...]
</code></pre>
<p>Our file has this amount of command lines:</p>
<pre><code>$ wc -l import_lb_rules.sh
      10 import_lb_rules.sh
</code></pre>
<p>The numbers might differ on your infrastructure if you use additional ports.
Before we import these resources again we will drop state for the load balancer rules:</p>
<pre><code class="language-bash">for addr in $(terraform state pull | jq -r '.resources[] | select(.module != null) |select(.module|startswith(&quot;module.dcos.module.dcos-infrastructure.module.loadbalancers&quot;)) | select(.type==&quot;azurerm_lb_rule&quot;)| . as $i | .instances[] | $i.module+&quot;.&quot;+$i.type+&quot;.&quot;+$i.name+(if .index_key == null then &quot;&quot; else &quot;[&quot;+(.index_key|tostring)+&quot;]&quot; end)'); do terraform state rm &quot;${addr}&quot;;done
</code></pre>
<p>After dropping the state we import the load balancer rules into our new format</p>
<pre><code>bash -x ./import_lb_rules.sh
</code></pre>
<p>Some references got lost in the process. But we can easily reproduce them. The following statement will reimport <code>azurerm_network_interface_security_group_association</code> into the terraform state.</p>
<pre><code>$ terraform plan -out=tf.plan &amp;&amp; terraform show -json tf.plan | jq -r '.resource_changes[] | select(.type == &quot;azurerm_network_interface_security_group_association&quot;) | &quot;terraform import \&quot;&quot;+ .address +&quot;\&quot; \&quot;&quot;+.change.after.network_interface_id+&quot;|&quot;+.change.after.network_security_group_id+&quot;\&quot;&quot;' | bash -
</code></pre>
<p>After this is finished we need to run a final apply as in the new format terraform needs to create some security rules:</p>
<pre><code>$ terraform apply
</code></pre>
<p>from now on <code>terraform plan</code> should not show any additional changes.</p>
</article></div><aside class="content__sections"><div class="content__sections-list-container"><ul class="content__sections-list"><li class="content__sections-item content__sections-item--h1"><a href="#upgrade-universal-installer-02-to-03">Upgrade Universal Installer 0.2 to 0.3</a></li><li class="content__sections-item content__sections-item--h2"><a href="#preparation">Preparation</a></li><li class="content__sections-item content__sections-item--h2"><a href="#translate-terraform-011-maintf-into-012">Translate terraform 0.11 main.tf into 0.12</a></li><li class="content__sections-item content__sections-item--h2"><a href="#start-the-upgrade-procedure">Start the upgrade procedure</a></li></ul></div></aside></main></div></div><script src="/dcosdocs/assets/js/jquery-3.2.1.js"></script><script src="/dcosdocs/assets/js/clipboard.js"></script><script src="/dcosdocs/assets/js/prism.js"></script><script src="/js/main.js"></script></body></html>